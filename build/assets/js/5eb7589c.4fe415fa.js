"use strict";(self.webpackChunktremor_website=self.webpackChunktremor_website||[]).push([[1487],{48046:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>c,frontMatter:()=>i,metadata:()=>s,toc:()=>p});var a=t(58168),r=(t(96540),t(15680));t(40281);const i={sidebar_position:1},o="Scripts",s={unversionedId:"language/scripts",id:"version-0.12/language/scripts",title:"Scripts",description:"Tremor scripts are user-defined pipeline [Operators]. They also have the standard ports in, out and err and are part of the [Pipeline] graph. Events are routed into and out of scripts using the [Select] statement inside a [Pipeline].",source:"@site/versioned_docs/version-0.12/language/scripts.md",sourceDirName:"language",slug:"/language/scripts",permalink:"/docs/0.12/language/scripts",draft:!1,editUrl:"https://github.com/tremor-rs/tremor-www/tree/main/versioned_docs/version-0.12/language/scripts.md",tags:[],version:"0.12",sidebarPosition:1,frontMatter:{sidebar_position:1},sidebar:"indexSidebar",previous:{title:"Pipelines",permalink:"/docs/0.12/language/pipelines"},next:{title:"Functions",permalink:"/docs/0.12/language/functions"}},l={},p=[{value:"Execution",id:"execution",level:2},{value:"Local variables",id:"local-variables",level:3},{value:"Emitting events",id:"emitting-events",level:3},{value:"Dropping events",id:"dropping-events",level:3},{value:"Errors",id:"errors",level:3}],d={toc:p},g="wrapper";function c(e){let{components:n,...t}=e;return(0,r.yg)(g,(0,a.A)({},d,t,{components:n,mdxType:"MDXLayout"}),(0,r.yg)("h1",{id:"scripts"},"Scripts"),(0,r.yg)("p",null,"Tremor scripts are user-defined pipeline ",(0,r.yg)("a",{parentName:"p",href:"../reference/operators"},"Operators"),". They also have the standard ports ",(0,r.yg)("inlineCode",{parentName:"p"},"in"),", ",(0,r.yg)("inlineCode",{parentName:"p"},"out")," and ",(0,r.yg)("inlineCode",{parentName:"p"},"err")," and are part of the ",(0,r.yg)("a",{parentName:"p",href:"/docs/0.12/language/pipelines"},"Pipeline")," graph. Events are routed into and out of scripts using the ",(0,r.yg)("a",{parentName:"p",href:"/docs/0.12/language/pipelines#select-queries"},"Select")," statement inside a ",(0,r.yg)("a",{parentName:"p",href:"/docs/0.12/language/pipelines"},"Pipeline"),"."),(0,r.yg)("p",null,"Scripts need to be defined using the ",(0,r.yg)("a",{parentName:"p",href:"/docs/0.12/language/reference/full#rule-definescript"},"Script definition statement")," and created by using the ",(0,r.yg)("a",{parentName:"p",href:"/docs/0.12/language/reference/full#rule-createscript"},"Script create statement"),". They can have ",(0,r.yg)("a",{parentName:"p",href:"/docs/0.12/language/#arguments"},"Arguments")," that can be provided upon creation."),(0,r.yg)("p",null,"Example:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-tremor"},"define script add\nargs\n    summand\nscript\n    emit event + args.summand\nend;\n\ncreate script add_one from add\nwith\n    summand = 1\nend;\n")),(0,r.yg)("h2",{id:"execution"},"Execution"),(0,r.yg)("p",null,"Scripts are executed and evaluated for each event ",(0,r.yg)("a",{parentName:"p",href:"/docs/0.12/language/pipelines#select-queries"},"Select"),"ed into its ",(0,r.yg)("inlineCode",{parentName:"p"},"in")," port. They are interpreted statement by statement, at each execution step the ",(0,r.yg)("a",{parentName:"p",href:"/docs/0.12/language/#events"},"event"),", the script state and the local variable stack can be manipulated."),(0,r.yg)("p",null,"During execution, the payload of the current event is available via the special ",(0,r.yg)("inlineCode",{parentName:"p"},"event")," ",(0,r.yg)("a",{parentName:"p",href:"/docs/0.12/language/expressions#paths"},"path"),". As on each other level inside the Tremor runtime ",(0,r.yg)("a",{parentName:"p",href:"/docs/0.12/language/#events"},"events")," can be arbitrarily structured values, closely resembling JSON, but with some extensions. See the section on Tremors ",(0,r.yg)("a",{parentName:"p",href:"/docs/0.12/language/#type-system"},"Type System"),"."),(0,r.yg)("h3",{id:"local-variables"},"Local variables"),(0,r.yg)("p",null,"Local variables are introduced with the ",(0,r.yg)("a",{parentName:"p",href:"/docs/0.12/language/reference/script#rule-let"},(0,r.yg)("inlineCode",{parentName:"a"},"let")," statement"),". The ",(0,r.yg)("inlineCode",{parentName:"p"},"let")," statement is also used for assigning values to existing variables or for adding new fields to a ",(0,r.yg)("a",{parentName:"p",href:"/docs/0.12/language/expressions#records"},"record")," value."),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-tremor"},'use std::random;\n\n# assign to new local variable\nlet new_local = event.field + 4;\n\n# assign to an existing nested field\nlet event.existing_field = std::random::integer(1, 10);\n\n# reassign\nlet new_local = new_local + 1;\n\n# add a new record field\nlet event.new_field = "snot";\n')),(0,r.yg)("p",null,"Local variables are scoped to the current script or function context. There is no variable shadowing."),(0,r.yg)("h3",{id:"emitting-events"},"Emitting events"),(0,r.yg)("p",null,"In Tremor, every ",(0,r.yg)("a",{parentName:"p",href:"/docs/0.12/language/expressions"},"expression")," and statement has a return value and the return value last statement in a script determines the payload of the output event. To explicitly control when and what is returned from a script, the ",(0,r.yg)("a",{parentName:"p",href:"/docs/0.12/language/reference/script#rule-emit"},(0,r.yg)("inlineCode",{parentName:"a"},"emit"))," statement can be used. The script execution terminates when an ",(0,r.yg)("a",{parentName:"p",href:"/docs/0.12/language/reference/script#rule-emit"},(0,r.yg)("inlineCode",{parentName:"a"},"emit"))," is hit in the script control flow. As such it can be used to exit a script early or to route events to different output ports."),(0,r.yg)("p",null,"The general form is:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre"},"emit [<EXPR>] [=> <PORT>]\n")),(0,r.yg)("p",null,"where ",(0,r.yg)("inlineCode",{parentName:"p"},"EXPR")," is any kind of ",(0,r.yg)("a",{parentName:"p",href:"/docs/0.12/language/expressions"},"expression")," and ",(0,r.yg)("inlineCode",{parentName:"p"},"PORT")," is also an expression evaluating to a string.\nBoth can be omitted. The default value for ",(0,r.yg)("inlineCode",{parentName:"p"},"EXPR")," is ",(0,r.yg)("inlineCode",{parentName:"p"},"event"),", so it will emit the current event. The default value for ",(0,r.yg)("inlineCode",{parentName:"p"},"PORT")," is ",(0,r.yg)("inlineCode",{parentName:"p"},'"out"'),", so it will emit ",(0,r.yg)("inlineCode",{parentName:"p"},"EXPR")," to the ",(0,r.yg)("inlineCode",{parentName:"p"},"out")," port of the script."),(0,r.yg)("p",null,"The following example will emit ",(0,r.yg)("inlineCode",{parentName:"p"},"event")," to the ",(0,r.yg)("inlineCode",{parentName:"p"},"out")," port:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-tremor"},"emit;\n")),(0,r.yg)("p",null,"The following example will emit a random number to the ",(0,r.yg)("inlineCode",{parentName:"p"},"rand")," port:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-tremor"},'use std::random;\n\nemit random::integer() => "rand";\n')),(0,r.yg)("p",null,'The following example will emit the string "snot" to the port provided in the ',(0,r.yg)("inlineCode",{parentName:"p"},"port")," field of the current event:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-tremor"},'emit "snot" => event.port;\n')),(0,r.yg)("p",null,"The following example will emit an error message if a required field is missing and otherwise carries on with the control flow:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-tremor"},'match event of\n  case %{ absent required_field } =>\n    emit "\'required_field\' is missing" => "err"\n  default => null\nend;\n\ndo_something(event.required_field)\n# ...\n')),(0,r.yg)("h3",{id:"dropping-events"},"Dropping events"),(0,r.yg)("p",null,"The ","[",(0,r.yg)("inlineCode",{parentName:"p"},"drop"),"]"," statement can be used to stop forwarding the current event and also stop execution of the current script. The input event will not be considered acknowledged or failed, but simply dropped and not passed on to the next pipeline ","[operator]"," or output port."),(0,r.yg)("p",null,"Example:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-tremor"},'match event of\n  %{ action = "drop" } => drop;\n  default => \n    # do something else\nend;\n')),(0,r.yg)("h3",{id:"errors"},"Errors"),(0,r.yg)("p",null,"Every Script can error for many reasons, but the most common reasons for errors are:"),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},"Treating some variable as a type (e.g. accessing field of a record) that it actually isnt."),(0,r.yg)("li",{parentName:"ul"},"Accessing a field on a record that doesn't exist."),(0,r.yg)("li",{parentName:"ul"},"Accessing an index on an array that is out of bounds.")),(0,r.yg)("p",null,"When a script errors, the input event is discarded and a synthetic event is sent to stdout. The format of the error event is:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-tremor"},'{\n    "error":"Error: \\n   13 |           event.snot\\n      |                 ^^^^ Conflicting types, got string but expected record\\n\\n",\n    "event":"{}"\n}\n')),(0,r.yg)("p",null,"To make errors visible to users and to actually act upon them they need to be selected from the ",(0,r.yg)("inlineCode",{parentName:"p"},"err")," port. A common pattern is to forward it to the pipeline ",(0,r.yg)("inlineCode",{parentName:"p"},"err")," port:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-tremor"},"define script foo\nscript\n    # trigger an error\n    emit event.some_non_existing_field;\nend;\ncreate script foo;\n\nselect event from in into foo;\nselect event from foo into out;\n# foward the script error to the pipeline `err` port\nselect event from foo/err into err;\n")))}c.isMDXComponent=!0}}]);