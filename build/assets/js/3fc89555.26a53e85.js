"use strict";(self.webpackChunktremor_website=self.webpackChunktremor_website||[]).push([[7549],{51048:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>s,contentTitle:()=>i,default:()=>g,frontMatter:()=>o,metadata:()=>l,toc:()=>m});var r=t(58168),a=(t(96540),t(15680));t(40281);const o={sidebar_label:"bench (Benchmarking)",sidebar_position:100},i="The bench Connector",l={unversionedId:"reference/connectors/bench",id:"version-0.12/reference/connectors/bench",title:"The bench Connector",description:"This connector is not intended for production use, but for testing the Tremor runtime itself. To enable it pass --debug-connectors to tremor.",source:"@site/versioned_docs/version-0.12/reference/connectors/bench.md",sourceDirName:"reference/connectors",slug:"/reference/connectors/bench",permalink:"/docs/0.12/reference/connectors/bench",draft:!1,editUrl:"https://github.com/tremor-rs/tremor-www/tree/main/versioned_docs/version-0.12/reference/connectors/bench.md",tags:[],version:"0.12",sidebarPosition:100,frontMatter:{sidebar_label:"bench (Benchmarking)",sidebar_position:100},sidebar:"indexSidebar",previous:{title:"ws (Web Sockets)",permalink:"/docs/0.12/reference/connectors/ws"},next:{title:"null (No messages)",permalink:"/docs/0.12/reference/connectors/null"}},s={},m=[{value:"Configuration",id:"configuration",level:2},{value:"Example",id:"example",level:3},{value:"Operation",id:"operation",level:2},{value:"How do I write a benchmark?",id:"how-do-i-write-a-benchmark",level:2},{value:"Constraints",id:"constraints",level:2}],p={toc:m},c="wrapper";function g(e){let{components:n,...t}=e;return(0,a.yg)(c,(0,r.A)({},p,t,{components:n,mdxType:"MDXLayout"}),(0,a.yg)("h1",{id:"the-bench-connector"},"The ",(0,a.yg)("inlineCode",{parentName:"h1"},"bench")," Connector"),(0,a.yg)("admonition",{type:"info"},(0,a.yg)("p",{parentName:"admonition"},"This connector is not intended for production use, but for testing the Tremor runtime itself. To enable it pass ",(0,a.yg)("inlineCode",{parentName:"p"},"--debug-connectors")," to tremor.")),(0,a.yg)("p",null,"The ",(0,a.yg)("inlineCode",{parentName:"p"},"bench")," connector enables controlled micro-benchmarking of tremor-based\napplications. Benchmarks and micro-benchmarking are an important part of the\nperformance engineering practices of the tremor authors."),(0,a.yg)("p",null,"We maintain and publish ",(0,a.yg)("a",{parentName:"p",href:"https://www.tremor.rs/benchmarks/"},"benchmark results")," that are\npublished every time code is commited to the main ","[tremor runtime]","(",(0,a.yg)("a",{parentName:"p",href:"https://github.com/tremor-rs/tremor-runtime%5D"},"https://github.com/tremor-rs/tremor-runtime]")," git repository\nusing bare metal infrastructure provided by the ",(0,a.yg)("a",{parentName:"p",href:"https://www.cncf.io"},"CNCF")," on ",(0,a.yg)("a",{parentName:"p",href:"https://metal.equinix.com/"},"Equinix Metal"),"\nwhere we host a simple ",(0,a.yg)("a",{parentName:"p",href:"https://github.com/tremor-rs/tremor-benchmark"},"continuous benchmarking service")," designed for this\npurpose."),(0,a.yg)("h2",{id:"configuration"},"Configuration"),(0,a.yg)("table",null,(0,a.yg)("thead",{parentName:"table"},(0,a.yg)("tr",{parentName:"thead"},(0,a.yg)("th",{parentName:"tr",align:null},"Config Option"),(0,a.yg)("th",{parentName:"tr",align:null},"Description"),(0,a.yg)("th",{parentName:"tr",align:null},"Possible Values"),(0,a.yg)("th",{parentName:"tr",align:null},"Required / Optional"),(0,a.yg)("th",{parentName:"tr",align:null},"Default Value"))),(0,a.yg)("tbody",{parentName:"table"},(0,a.yg)("tr",{parentName:"tbody"},(0,a.yg)("td",{parentName:"tr",align:null},"source"),(0,a.yg)("td",{parentName:"tr",align:null},"The source file to read data from, can be xz compressed"),(0,a.yg)("td",{parentName:"tr",align:null},"file path"),(0,a.yg)("td",{parentName:"tr",align:null},"required"),(0,a.yg)("td",{parentName:"tr",align:null})),(0,a.yg)("tr",{parentName:"tbody"},(0,a.yg)("td",{parentName:"tr",align:null},"interval"),(0,a.yg)("td",{parentName:"tr",align:null},"The interval between single events in nanoseconds. Set to ",(0,a.yg)("inlineCode",{parentName:"td"},"0")," if you want events emitted as fast as possible."),(0,a.yg)("td",{parentName:"tr",align:null},"positive integer"),(0,a.yg)("td",{parentName:"tr",align:null},"optional"),(0,a.yg)("td",{parentName:"tr",align:null},(0,a.yg)("inlineCode",{parentName:"td"},"0"))),(0,a.yg)("tr",{parentName:"tbody"},(0,a.yg)("td",{parentName:"tr",align:null},"chunk_size"),(0,a.yg)("td",{parentName:"tr",align:null},"if provided, the ",(0,a.yg)("inlineCode",{parentName:"td"},"source")," file data will be split into chunks of the given size, instead of split into lines."),(0,a.yg)("td",{parentName:"tr",align:null},"positive integer"),(0,a.yg)("td",{parentName:"tr",align:null},"optional"),(0,a.yg)("td",{parentName:"tr",align:null})),(0,a.yg)("tr",{parentName:"tbody"},(0,a.yg)("td",{parentName:"tr",align:null},"iters"),(0,a.yg)("td",{parentName:"tr",align:null},"Number of iterations through the whole ",(0,a.yg)("inlineCode",{parentName:"td"},"source")," data to stop after. If not provided (and ",(0,a.yg)("inlineCode",{parentName:"td"},"stop_after_secs")," is also not provided), the connector will iterate over the ",(0,a.yg)("inlineCode",{parentName:"td"},"source")," data infinitely."),(0,a.yg)("td",{parentName:"tr",align:null},"positive integer"),(0,a.yg)("td",{parentName:"tr",align:null},"optional"),(0,a.yg)("td",{parentName:"tr",align:null})),(0,a.yg)("tr",{parentName:"tbody"},(0,a.yg)("td",{parentName:"tr",align:null},"base64"),(0,a.yg)("td",{parentName:"tr",align:null},"If set to ",(0,a.yg)("inlineCode",{parentName:"td"},"true"),", the ",(0,a.yg)("inlineCode",{parentName:"td"},"source")," data will be ",(0,a.yg)("inlineCode",{parentName:"td"},"base64")," decoded."),(0,a.yg)("td",{parentName:"tr",align:null},"boolean"),(0,a.yg)("td",{parentName:"tr",align:null},"optional"),(0,a.yg)("td",{parentName:"tr",align:null},(0,a.yg)("inlineCode",{parentName:"td"},"false"))),(0,a.yg)("tr",{parentName:"tbody"},(0,a.yg)("td",{parentName:"tr",align:null},"is_transactional"),(0,a.yg)("td",{parentName:"tr",align:null},"If set to ",(0,a.yg)("inlineCode",{parentName:"td"},"true"),", events will be emitted as transactional (requiring ack/fail contraflow messages)."),(0,a.yg)("td",{parentName:"tr",align:null},"boolean"),(0,a.yg)("td",{parentName:"tr",align:null},"optional"),(0,a.yg)("td",{parentName:"tr",align:null},(0,a.yg)("inlineCode",{parentName:"td"},"false"))),(0,a.yg)("tr",{parentName:"tbody"},(0,a.yg)("td",{parentName:"tr",align:null},"structured"),(0,a.yg)("td",{parentName:"tr",align:null},"If set to ",(0,a.yg)("inlineCode",{parentName:"td"},"true")," the benchmark report is output as JSON, if set to ",(0,a.yg)("inlineCode",{parentName:"td"},"false")," it is printed in human-readable form."),(0,a.yg)("td",{parentName:"tr",align:null},"boolean"),(0,a.yg)("td",{parentName:"tr",align:null},"optional"),(0,a.yg)("td",{parentName:"tr",align:null},(0,a.yg)("inlineCode",{parentName:"td"},"false"))),(0,a.yg)("tr",{parentName:"tbody"},(0,a.yg)("td",{parentName:"tr",align:null},"stop_after_secs"),(0,a.yg)("td",{parentName:"tr",align:null},"Number of seconds after which the benchmark should be stopped."),(0,a.yg)("td",{parentName:"tr",align:null},"positive integer"),(0,a.yg)("td",{parentName:"tr",align:null},"optional"),(0,a.yg)("td",{parentName:"tr",align:null})),(0,a.yg)("tr",{parentName:"tbody"},(0,a.yg)("td",{parentName:"tr",align:null},"significant_figures"),(0,a.yg)("td",{parentName:"tr",align:null},"Digits of precision for latency HDR histogram results."),(0,a.yg)("td",{parentName:"tr",align:null},"positive integer"),(0,a.yg)("td",{parentName:"tr",align:null},"optional"),(0,a.yg)("td",{parentName:"tr",align:null},(0,a.yg)("inlineCode",{parentName:"td"},"2"))),(0,a.yg)("tr",{parentName:"tbody"},(0,a.yg)("td",{parentName:"tr",align:null},"warmup_secs"),(0,a.yg)("td",{parentName:"tr",align:null},"Number of seconds to warm up. Events during this time are not accounted for in the latency measurements."),(0,a.yg)("td",{parentName:"tr",align:null},"positive integer"),(0,a.yg)("td",{parentName:"tr",align:null},"optional"),(0,a.yg)("td",{parentName:"tr",align:null},(0,a.yg)("inlineCode",{parentName:"td"},"0"))))),(0,a.yg)("h3",{id:"example"},"Example"),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre",className:"language-tremor",metastring:'title="example.troy"',title:'"example.troy"'},'use std::time::nanos;\ndefine connector bench from bench\nwith\n  codec = "json",                         # Decode each line as a JSON document\n  config = {\n    "source": "in.json",                # Take the source data from `in.json` and turn each line into an event\n    "interval": nanos::from_millis(1),  # Wait for 1ms between each event\n    "iters": 1,                         # Iterate only once through the data in `in.json`\n  }\nend;\n')),(0,a.yg)("h2",{id:"operation"},"Operation"),(0,a.yg)("p",null,"The ",(0,a.yg)("inlineCode",{parentName:"p"},"bench")," connector consists of two parts. The ",(0,a.yg)("em",{parentName:"p"},"source")," part for generating synthetical loads of events and the ",(0,a.yg)("em",{parentName:"p"},"sink")," part, measuring how many events it got and the latency of each event."),(0,a.yg)("p",null,"The ",(0,a.yg)("em",{parentName:"p"},"source")," part will load an emulated source of events from a (possibly ",(0,a.yg)("inlineCode",{parentName:"p"},"xz")," compressed) file and load them into memory.\nIt is required to send the emitted events to the ",(0,a.yg)("em",{parentName:"p"},"sink")," part via the ",(0,a.yg)("inlineCode",{parentName:"p"},"in")," port of the same connector eventually.\nThe pipelines and connectors in between can be considered the system that is subject to the benchmark."),(0,a.yg)("p",null,"The ",(0,a.yg)("em",{parentName:"p"},"source")," part is replaying its contents for the duration of the test, or until the number of configured test iterations has been\nexceeded; whichever happens first. Once the test has been stopped a high dynamic range ",(0,a.yg)("a",{parentName:"p",href:"http://hdrhistogram.org/"},"HDR Histogram"),"\nis produced and printed to stdout. The histogram can be loaded into the web based ",(0,a.yg)("a",{parentName:"p",href:"http://hdrhistogram.github.io/HdrHistogram/plotFiles.html"},"histogram plotting tool")," for analysis."),(0,a.yg)("p",null,"Once the latency histogram and throughput measures have been emitted, the tremor runtime process is halted."),(0,a.yg)("h2",{id:"how-do-i-write-a-benchmark"},"How do I write a benchmark?"),(0,a.yg)("p",null,"The most important part of writing a benchmark with the ",(0,a.yg)("inlineCode",{parentName:"p"},"bench")," connector is that the ",(0,a.yg)("em",{parentName:"p"},"source")," part\nneeds to be the source of events. Usually the ",(0,a.yg)("em",{parentName:"p"},"source")," part emits events as fast as it possibly can, in order to see how much the whole system is actually able to handle inm the best case."),(0,a.yg)("p",null,"The ",(0,a.yg)("em",{parentName:"p"},"sink")," part needs to receive the events eventually, otherwise the benchmark does not measure anything. In that case the ",(0,a.yg)("inlineCode",{parentName:"p"},"bench")," connector can be used as a load generator."),(0,a.yg)("p",null,"A complete benchmark will define the ",(0,a.yg)("inlineCode",{parentName:"p"},"bench")," connector as in the\nconfiguration example above with a system under test defined in a deployment file. A full\nexample is provided for illustration."),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre",className:"language-tremor",metastring:'title="config.troy"',title:'"config.troy"'},'define flow main\nflow\n  use tremor::connectors;\n\n  define connector bench from bench\n  with\n    codec = "json",\n    config = {\n      "source": "in.json",\n      "stop_after_secs": 10,\n      "warmup_secs": 2\n    }\n  end;\n  create connector bench;\n\n  define pipeline bench_me\n  pipeline\n    # this is just a dummy pipeline.\n    # What we actually benchmark here is how much throughput the vanilla tremor runtime\n    # without any application logic can achieve.\n    select event from in into out;\n  end;\n  create pipeline bench_me;\n\n  # send synthetical load of events to the pipeline\n  connect /connector/bench to /pipeline/bench_me;\n  # send events to the bench connector for measuring and reporting\n  connect /pipeline/bench_me to /connector/bench;\nend;\n\ndeploy flow main;\n')),(0,a.yg)("p",null,"This is a test of the benchmark connector itself that is exercised as part of our CI system, it can be run\nmanually as follows:"),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre",className:"language-bash"},"$ git clone https://github.com/tremor-rs/tremor-runtime\n$ cd tremor-runtime\n$ cargo build --all --release # grab a coffee, this takes a while\n$ cd tremor-cli/tests/integration/blaster # Piu piu!\n$ export TREMOR_PATH=/path/to/tremor-runtime/tremor-script/lib\n$ tremor test bench .\n  Running `target/debug/tremor test bench -v temp/bench`\n  Benchmark: Running bench\n    Tags:  bench\n\n       | Value Percentile TotalCount 1/(1-Percentile)\n       | \n       | 8575 0.00000          1           1.00\n       | 15679 0.25000     249319           1.33\n       | 18559 0.50000     507133           2.00\n       | 20223 0.62500     626440           2.67\n       | 25087 0.75000     746698           4.00\n       | 237567 0.81250     808828           5.33\n       | 770047 0.87500     871282           8.00\n       | 1146879 0.90625     902347          10.67\n       | 1703935 0.93750     933194          16.00\n       | 2097151 0.95312     948800          21.33\n       | 2506751 0.96875     964503          32.00\n       | 2670591 0.97656     972719          42.67\n       | 2818047 0.98438     979971          64.00\n       | 2981887 0.98828     983951          85.33\n       | 3309567 0.99219     987641         128.00\n       | 3571711 0.99414     989559         170.67\n       | 3964927 0.99609     991540         256.00\n       | 4259839 0.99707     992494         341.33\n       | 4751359 0.99805     993481         512.00\n       | 5079039 0.99854     993936         682.67\n       | 5439487 0.99902     994468        1024.00\n       | 5537791 0.99927     994776        1365.33\n       | 5668863 0.99951     994894        2048.00\n       | 6029311 0.99963     995017        2730.67\n       | 6225919 0.99976     995133        4096.00\n       | 6619135 0.99982     995194        5461.33\n       | 6914047 0.99988     995349        8192.00\n       | 6914047 0.99991     995349       10922.67\n       | 6914047 0.99994     995349       16384.00\n       | 6914047 0.99995     995349       21845.33\n       | 6914047 0.99997     995349       32768.00\n       | 6946815 0.99998     995376       43690.67\n       | 6946815 1.00000     995376            inf\n       | #[Mean       =    285758.86, StdDeviation   =    701828.62]\n       | #[Max        =      6946815, Total count    =       995376]\n       | #[Buckets    =           30, SubBuckets     =         3968]\n       | \n       | \n       | Throughput   (data): 0.5 MB/s\n       | Throughput (events): 99.5k events/s\n\n  Elapsed: 12s 40ms\n")),(0,a.yg)("h2",{id:"constraints"},"Constraints"),(0,a.yg)("p",null,"It is an error to attempt to run a benchmark ( any deployment using the ",(0,a.yg)("inlineCode",{parentName:"p"},"bench")," connector )\nvia the regular server execution command in the ",(0,a.yg)("inlineCode",{parentName:"p"},"tremor")," command line interface"),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre",className:"language-bash"},"\u279c  blaster git:(main) \u2717 tremor server run config.troy\ntremor version: 0.12 \ntremor instance: tremor\nrd_kafka version: 0x000002ff, 1.8.2\nallocator: snmalloc\n[2022-04-12T14:38:20Z ERROR tremor_runtime::system] Error starting deployment of flow main: Unknown connector type bench\nError: An error occurred while loading the file `config.troy`: Error deploying Flow main: Unknown connector type bench\n[2022-04-12T14:38:20Z ERROR tremor::server] Error: An error occurred while loading the file `config.troy`: Error deploying Flow main: Unknown connector type bench\nWe are SHUTTING DOWN due to errors during initialization!\n[2022-04-12T14:38:20Z ERROR tremor::server] We are SHUTTING DOWN due to errors during initialization!\n")),(0,a.yg)("p",null,"In order to run the the ",(0,a.yg)("inlineCode",{parentName:"p"},"tremor server run")," with the bench connector, add the ",(0,a.yg)("inlineCode",{parentName:"p"},"--debug-connectors")," flag."))}g.isMDXComponent=!0}}]);