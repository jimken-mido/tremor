"use strict";(self.webpackChunktremor_website=self.webpackChunktremor_website||[]).push([[2578],{65645:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>o,default:()=>g,frontMatter:()=>s,metadata:()=>r,toc:()=>d});var a=n(58168),i=(n(96540),n(15680));const s={title:"Case Study - Traffic Shaping",tags:["case-study","wayfair"],author:"The Tremor Team",author_url:"https://github.com/tremor-rs",author_image_url:"https://avatars.githubusercontent.com/u/60009416?s=200&v=4",image:"./media/wayfair.png",draft:!1,hide_table_of_contents:!1},o="Traffic Shaping",r={permalink:"/blog/2021/11/02/traffic-shaping",editUrl:"https://github.com/tremor-rs/tremor-www/tree/main/blog/2021-11-02-traffic-shaping.md",source:"@site/blog/2021-11-02-traffic-shaping.md",title:"Case Study - Traffic Shaping",description:"Happened Before",date:"2021-11-02T00:00:00.000Z",formattedDate:"November 2, 2021",tags:[{label:"case-study",permalink:"/blog/tags/case-study"},{label:"wayfair",permalink:"/blog/tags/wayfair"}],readingTime:4.265,hasTruncateMarker:!1,authors:[{name:"The Tremor Team",url:"https://github.com/tremor-rs",imageURL:"https://avatars.githubusercontent.com/u/60009416?s=200&v=4"}],frontMatter:{title:"Case Study - Traffic Shaping",tags:["case-study","wayfair"],author:"The Tremor Team",author_url:"https://github.com/tremor-rs",author_image_url:"https://avatars.githubusercontent.com/u/60009416?s=200&v=4",image:"./media/wayfair.png",draft:!1,hide_table_of_contents:!1},prevItem:{title:"Case Study - Data Distribution",permalink:"/blog/2021/11/03/data-distribution"},nextItem:{title:"Wayfair Case Study",permalink:"/blog/2021/11/01/wayfair-case-studies"}},l={image:n(21697).A,authorsImageUrls:[void 0]},d=[{value:"Happened Before",id:"happened-before",level:2},{value:"Identified Need",id:"identified-need",level:2},{value:"Required Outcome",id:"required-outcome",level:2},{value:"Characteristics",id:"characteristics",level:3},{value:"Solution",id:"solution",level:3},{value:"Conclusion",id:"conclusion",level:2}],c={toc:d},u="wrapper";function g(e){let{components:t,...s}=e;return(0,i.yg)(u,(0,a.A)({},c,s,{components:t,mdxType:"MDXLayout"}),(0,i.yg)("h2",{id:"happened-before"},"Happened Before"),(0,i.yg)("p",null,"This is our origin story. The simplified high level architecture of our\nlogging systems at  the time of tremor\u2019s birth is:"),(0,i.yg)("p",null,(0,i.yg)("img",{alt:"old pipeline",src:n(68229).A,width:"598",height:"168"})),(0,i.yg)("h2",{id:"identified-need"},"Identified Need"),(0,i.yg)("p",null,"Enable load shedding and consistent capacity management at production\nscale of the logging and metrics firehoses within Wayfair\u2019s production,\nstaging and development environments; even when our live production\nworking set exceeds planned capacity, but especially when catastrophic\nfailure of infrastructure overwhelms our storage tier."),(0,i.yg)("h2",{id:"required-outcome"},"Required Outcome"),(0,i.yg)("p",null,"Our network operations center, system reliability and service\norganization engineers should never be in a position where in-flight\nmission-critical events are unavailable or lagging ( seconds or even\nminutes ) the live working set state of our production systems."),(0,i.yg)("p",null,"Stale operational events direct limited resources under time constraints\nand production service level objective pressures to curing or tending to\nthe wrong problems, at the wrong times and lead to missed opportunities\nfor early and cheap resolution."),(0,i.yg)("h3",{id:"characteristics"},"Characteristics"),(0,i.yg)("p",null,"It is understood that, if a critical system ( such as a production\ndatabase ) fails - query failures won\u2019t have a single point of origin in\nthe logs - whether over time, or across application or business units.\nWhen under extreme load beyond capacity - only a subset of the firehose\nis required for in-flight diagnostics of our production estate."),(0,i.yg)("blockquote",null,(0,i.yg)("p",{parentName:"blockquote"},"In-flight categorization, classification & rate limiting enables\n",(0,i.yg)("strong",{parentName:"p"},"just-in-time traffic shaping"),", load-shedding and bending critical\ninfrastructure to available capacity even as capacity   changes in\nplanned or surprising ways.")),(0,i.yg)("p",null,"It is understood that, regardless of the system state - that some logs\nfrom a subset of systems, applications or services are relatively more\nimportant than others. This is even more true when our systems and\nservices are under extraordinary strain due to unplanned failures and\noutages. Unplanned failures and outages are expected at Wayfair\nproduction scale."),(0,i.yg)("blockquote",null,(0,i.yg)("p",{parentName:"blockquote"},"The ",(0,i.yg)("strong",{parentName:"p"},"relative priority")," of classified and categorized events is known\nand the relative priority is subject to change over time, as are the event\nclassifications and categorizations.")),(0,i.yg)("p",null,"It is likely impossible to convince thousands of engineers in hundreds\nof teams across our technology organization to stop using JSON format in\nthe short, medium and possibly even longer term."),(0,i.yg)("p",null,"Snot. It\u2019s a JSON rock\u2019n\u2019roll world. I guess we\u2019ll just have to deal\nwith it"),(0,i.yg)("h3",{id:"solution"},"Solution"),(0,i.yg)("p",null,"This works fine 99% of the time - but under extreme load it just does\nnot work at our scale and the impact to our network operations and\nservice reliability and technical communities is severe at the exact\nmoments when we are at peak trading periods and impact to the business\nis highest - a perfect storm."),(0,i.yg)("p",null,(0,i.yg)("img",{alt:"old pipeline",src:n(97870).A,width:"598",height:"84"})),(0,i.yg)("p",null,"In our ELK ( ElasticSearch, Logstash, Kibana ) based logging and Influx\n( Telegraf, Chronograf, InfluxDB ) based metrics environments there are\nlimited means to dynamically tune the production system to accommodate\nhighly variant working sets. As we are an online eCommerce system we\noften go through sustained periods of nominal activity followed by\ninsane periods of extreme peak activity - often hitting peaks we\u2019ve\nnever before experienced."),(0,i.yg)("p",null,"We do however, have a very experienced infrastructure and platform\nengineering organization that are deeply attuned to our working set and\nchanging business and operational needs."),(0,i.yg)("p",null,"The initial version of tremor simply preserved the overall pipeline:"),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},"Applications in a number of programming languages generate logs"),(0,i.yg)("li",{parentName:"ul"},"A Logstash sidecar receives, normalizes and forwards logs to\nelasticsearch"),(0,i.yg)("li",{parentName:"ul"},"ElasticSearch indexes logs for display by SRE\u2019s and developers in\nKibana")),(0,i.yg)("p",null,"The processing stages remained unchanged ( and largely serviced by\nLogstash ):"),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},"Enrich raw logs with business unit, organization, application and\nenvironment metadata"),(0,i.yg)("li",{parentName:"ul"},"Normalize schemas - map logs to a common structure and well known\nfield names"),(0,i.yg)("li",{parentName:"ul"},"Known unknowns - isolate user defined fields and extensions to a\nwell known slush field")),(0,i.yg)("p",null,"But added an extra processing stage, a tremor cluster that added\nback-pressure detection and load-adaptive rate-limiting based on\nin-flight analysis of the business events in the firehose based on\nreal-time categorization and classification of those event streams."),(0,i.yg)("p",null,"Now, in the ( significantly less than 1% ) of time when our systems are\nover-capacity or experiencing catastrophic unplanned events - tremor can\n",(0,i.yg)("em",{parentName:"p"},"discard")," events based rate limits and event classifications that can be\ntuned by our SRE, NOC and systems architects and developers."),(0,i.yg)("h2",{id:"conclusion"},"Conclusion"),(0,i.yg)("p",null,"Tremor\u2019s core mission and mandate started out with, and continues to be\nthe non-functional quality of service of mission critical at scale event\nbased systems. Providing system operators with first class means to\nshape and tune capacity, load and production countermeasures of the\nproduction firehose without compromising the business with system\ndowntime is the core requirement."),(0,i.yg)("p",null,"The most effective way to achieve this in a highly fluid and ever\nchanging environment is what has yielded the tremor project as it became\nto be - a general purpose event processing system designed for at scale\ndistributed mission critical systems."),(0,i.yg)("p",null,"When at or over capacity systems no longer bend to the business - tremor\nis how we inject a little elasticity into our production quality of\nservice - enriching our systems and services with just-in-time\nload-adaptive bendability."),(0,i.yg)("p",null,(0,i.yg)("img",{alt:"new pipeline",src:n(43447).A,width:"598",height:"168"})))}g.isMDXComponent=!0},68229:(e,t,n)=>{n.d(t,{A:()=>a});const a=n.p+"assets/images/image1-95f99ee914c307a91b9baa2c9b73c4ef.png"},97870:(e,t,n)=>{n.d(t,{A:()=>a});const a=n.p+"assets/images/image2-927514e3e7f7524272fe3cd0eb67b856.png"},43447:(e,t,n)=>{n.d(t,{A:()=>a});const a=n.p+"assets/images/image3-638996ab9adf5b141b60cdeb4ab8a2de.png"},21697:(e,t,n)=>{n.d(t,{A:()=>a});const a=n.p+"assets/images/wayfair-b0bafac5cf230fcd5e29c8cb4560c334.png"}}]);