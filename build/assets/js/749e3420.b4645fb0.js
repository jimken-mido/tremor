"use strict";(self.webpackChunktremor_website=self.webpackChunktremor_website||[]).push([[1903],{3204:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>l,contentTitle:()=>s,default:()=>p,frontMatter:()=>i,metadata:()=>r,toc:()=>c});var o=a(58168),n=(a(96540),a(15680));const i={title:"Support for the ClickHouse database in Tremor",author:"Sasha Pourcelot",author_title:"Tremor 2022 Spring Mentee",author_url:"https://github.com/scrabsha/",tags:["Database","ClickHouse"],draft:!1,description:"Sasha's Mentorship experience"},s="Introduction",r={permalink:"/blog/2022/07/07/LFX-Blog-Sasha",editUrl:"https://github.com/tremor-rs/tremor-www/tree/main/blog/2022-07-07-LFX-Blog-Sasha.md",source:"@site/blog/2022-07-07-LFX-Blog-Sasha.md",title:"Support for the ClickHouse database in Tremor",description:"Sasha's Mentorship experience",date:"2022-07-07T00:00:00.000Z",formattedDate:"July 7, 2022",tags:[{label:"Database",permalink:"/blog/tags/database"},{label:"ClickHouse",permalink:"/blog/tags/click-house"}],readingTime:5.215,hasTruncateMarker:!1,authors:[{name:"Sasha Pourcelot",title:"Tremor 2022 Spring Mentee",url:"https://github.com/scrabsha/"}],frontMatter:{title:"Support for the ClickHouse database in Tremor",author:"Sasha Pourcelot",author_title:"Tremor 2022 Spring Mentee",author_url:"https://github.com/scrabsha/",tags:["Database","ClickHouse"],draft:!1,description:"Sasha's Mentorship experience"},prevItem:{title:"Hygienic error handling and validation for pipelines",permalink:"/blog/2022/09/24/LFX-Blog-Carol"},nextItem:{title:"TDengine colaboration",permalink:"/blog/2022/06/15/tdengine-colaboration"}},l={authorsImageUrls:[void 0]},c=[{value:"Interacting with a ClickHouse database in Rust",id:"interacting-with-a-clickhouse-database-in-rust",level:2},{value:"Writing a super simple sink",id:"writing-a-super-simple-sink",level:2},{value:"Converting Tremor values to ClickHouse values",id:"converting-tremor-values-to-clickhouse-values",level:2},{value:"Testing",id:"testing",level:2},{value:"Improving the sink",id:"improving-the-sink",level:2},{value:"Automatically getting the table schema",id:"automatically-getting-the-table-schema",level:3},{value:"Inserting data concurrently",id:"inserting-data-concurrently",level:3},{value:"The source part",id:"the-source-part",level:2}],h={toc:c},u="wrapper";function p(e){let{components:t,...a}=e;return(0,n.yg)(u,(0,o.A)({},h,a,{components:t,mdxType:"MDXLayout"}),(0,n.yg)("p",null,"I'm Sasha, a Computer Science student living in south-eastern France. I contributed to Tremor as part of the ",(0,n.yg)("a",{parentName:"p",href:"https://mentorship.lfx.linuxfoundation.org/project/5c828028-f91c-4969-b4de-9efdb27bb869"},"Database Connector mentorship")," proposed by the ",(0,n.yg)("a",{parentName:"p",href:"https://lfx.linuxfoundation.org/tools/mentorship/"},"LFX Mentorship Program")," for Spring 2022. I was mentored by Matthias Wahl and got help from Darach Ennis, Heinz Gies and Ramona \u0141uczkiewicz."),(0,n.yg)("p",null,"This blogpost summarizes my work at Tremor as a mentee and shows what could be done next."),(0,n.yg)("h1",{id:"about-tremor"},"About Tremor"),(0,n.yg)("p",null,"Tremor is an event processing system with the goal of allowing users to handle a high volume of messages by viewing them as a stream flowing between different nodes of a graph. Events go in and out of this graph thanks to connectors."),(0,n.yg)("p",null,"The interactions between each node and the connector configuration are defined using the ",(0,n.yg)("a",{parentName:"p",href:"https://www.tremor.rs/docs/edge/language/"},(0,n.yg)("inlineCode",{parentName:"a"},"troy"))," programming language."),(0,n.yg)("h1",{id:"abstract"},"Abstract"),(0,n.yg)("p",null,"My mentorship at Tremor was focused on building a connector for the ",(0,n.yg)("a",{parentName:"p",href:"https://clickhouse.com/"},"ClickHouse")," database engine. More specifically, I was focused on the ",(0,n.yg)("em",{parentName:"p"},"sink")," part, the one that allows data to flow out of the Tremor application."),(0,n.yg)("p",null,(0,n.yg)("a",{parentName:"p",href:"https://clickhouse.com/"},"ClickHouse")," is a database management system designed to allow for real-time analysis of high volumes of non-aggregated data. Its initial goal was to power the Yandex.Metrica analytics platform."),(0,n.yg)("h1",{id:"the-clickhouse-connector"},"The ClickHouse connector"),(0,n.yg)("p",null,"The next subsections describe what I did during the mentorship."),(0,n.yg)("h2",{id:"interacting-with-a-clickhouse-database-in-rust"},"Interacting with a ClickHouse database in Rust"),(0,n.yg)("p",null,"My first goal was to find a way to send requests to a ClickHouse node from a Rust program. It was a good start because it allowed me to experiment on the ClickHouse side without caring about what was happening in Tremor. I spent around three weeks playing on a separate repository named ",(0,n.yg)("a",{parentName:"p",href:"https://github.com/scrabsha/plays-with-clickhouse"},(0,n.yg)("inlineCode",{parentName:"a"},"scrabsha/plays-with-clickhouse"))," and getting extensive knowledge from Matthias about how Tremor works from the inside."),(0,n.yg)("p",null,"I found two Rust crates that could help us send requests to a ClickHouse database: ",(0,n.yg)("a",{parentName:"p",href:"https://crates.io/crates/clickhouse"},(0,n.yg)("inlineCode",{parentName:"a"},"clickhouse"))," and ",(0,n.yg)("a",{parentName:"p",href:"https://crates.io/crates/clickhouse-rs"},(0,n.yg)("inlineCode",{parentName:"a"},"clickhouse-rs")),". ",(0,n.yg)("inlineCode",{parentName:"p"},"clickhouse")," is the first one I considered. I had to discard it because it was focused on concrete Rust types and needed to know ",(0,n.yg)("em",{parentName:"p"},"at compile time")," what each datatype is composed of. The second crate was a bit more low-level and allowed us to do what we need."),(0,n.yg)("h2",{id:"writing-a-super-simple-sink"},"Writing a super simple sink"),(0,n.yg)("p",null,"Once I got every ClickHouse detail right, I started playing with the Tremor side. There were multiple connectors already implemented in Tremor. I picked the simplest ones and started copying parts of it and quickly got something working."),(0,n.yg)("p",null,"The only challenge I encountered is that Tremor defines its own ",(0,n.yg)("inlineCode",{parentName:"p"},"Value")," type, representing a value whose type is not really known at compile time, and uses it ",(0,n.yg)("em",{parentName:"p"},"a lot"),". It was a bit disconcerting doing such things in Rust, as I felt I was writing dynamically-typed code in a statically-typed language, but I managed to get through it."),(0,n.yg)("h2",{id:"converting-tremor-values-to-clickhouse-values"},"Converting Tremor values to ClickHouse values"),(0,n.yg)("p",null,"Once I was able to insert data in a database from Tremor, I started writing a conversion bridge for ClickHouse types, i.e. something that would handle the conversion of native Tremor values to their corresponding ClickHouse types. "),(0,n.yg)("p",null,"Most of the conversions are quite simple: an integer can be obtained from an integer, a string can be obtained from any string, and so on."),(0,n.yg)("p",null,"Some other conversions were less obvious. For instance, in order to create a ClickHouse IPv4 type, we could either use a string representing the address, or an array of four integers. The goal was to make every ClickHouse type constructible from a Tremor value. I tried to make every conversion as obvious as possible, and to document them as much as possible."),(0,n.yg)("p",null,"The first implementation of this mapping function was huge. It was about 250 lines of tricky and slightly incorrect code. I managed to rewrite it from scratch using another approach and it got way better."),(0,n.yg)("p",null,"Working on this specific part led me to open three pull request to the ",(0,n.yg)("inlineCode",{parentName:"p"},"clickhouse-rs")," crate:"),(0,n.yg)("ul",null,(0,n.yg)("li",{parentName:"ul"},(0,n.yg)("a",{parentName:"li",href:"https://github.com/suharev7/clickhouse-rs/pull/171"},"Make Value fully constructible (#171)")),(0,n.yg)("li",{parentName:"ul"},(0,n.yg)("a",{parentName:"li",href:"https://github.com/suharev7/clickhouse-rs/pull/172"},"Compare IP adresses properly (#172)")),(0,n.yg)("li",{parentName:"ul"},(0,n.yg)("a",{parentName:"li",href:"https://github.com/suharev7/clickhouse-rs/pull/173"},"Allow for Enum8 and DateTime64 value comparison (#173)"))),(0,n.yg)("h2",{id:"testing"},"Testing"),(0,n.yg)("p",null,"The conversion function described in the previous subsection was fairly complex. Each possible conversion and cast has been carefully tested in order to ensure that it behaves correctly. These tests were greatly simplified thanks to the use of declarative macro."),(0,n.yg)("p",null,"Some other tests were focused on testing the sink as a whole, and how it would interact with a ClickHouse database. In this kind of test, we would run ClickHouse Docker containers, create a ClickHouse sink, plug the sink to the container, send some events, and see what has been inserted in the ClickHouse side."),(0,n.yg)("h1",{id:"what-to-do-next"},"What to do next?"),(0,n.yg)("h2",{id:"improving-the-sink"},"Improving the sink"),(0,n.yg)("h3",{id:"automatically-getting-the-table-schema"},"Automatically getting the table schema"),(0,n.yg)("p",null,"It turns out that ClickHouse has a ",(0,n.yg)("a",{parentName:"p",href:"https://clickhouse.com/docs/en/sql-reference/statements/describe-table"},(0,n.yg)("inlineCode",{parentName:"a"},"DESCRIBE TABLE")," statement"),", which allows to gather information about each column of a specific table. We currently rely on the end-user to provide us valid information about the table columns. Using this statement would reduce the amount of information we require from them, hence making it simpler to use."),(0,n.yg)("h3",{id:"inserting-data-concurrently"},"Inserting data concurrently"),(0,n.yg)("p",null,"The current implementation of the ClickHouse container uses a single database connection object, which is reused across insertions. A good way to improve this system is to use multiple concurrent connections, so that we could insert multiple batch of events at once."),(0,n.yg)("p",null,"A similar pattern has already been implemented in Tremor as part of the ",(0,n.yg)("a",{parentName:"p",href:"https://www.tremor.rs/docs/edge/reference/connectors/elastic"},(0,n.yg)("inlineCode",{parentName:"a"},"elastic"))," connector. As such, most of the required machinery is already there."),(0,n.yg)("h2",{id:"the-source-part"},"The source part"),(0,n.yg)("p",null,"This mentorship was focused on building a sink for ClickHouse. The next step could be to add a source connector, so that coming from a ClickHouse database can be ingested directly into a Tremor application."),(0,n.yg)("p",null,"ClickHouse has a feature allowing to watch for updates in a given table. This way, we can simulate a stream of data, and make it flow in the Tremor system. Each time some data is inserted in the table, we can retrieve it, convert it into Tremor value and make it flow into the graph of nodes described earlier."),(0,n.yg)("p",null,"This is something that we totally want to see in Tremor in the future. We can't wait for the ",(0,n.yg)("a",{parentName:"p",href:"https://clickhouse.com/docs/en/sql-reference/statements/watch/"},(0,n.yg)("inlineCode",{parentName:"a"},"WATCH")," statement")," to be considered stable."))}p.isMDXComponent=!0}}]);