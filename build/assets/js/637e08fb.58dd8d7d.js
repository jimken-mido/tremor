"use strict";(self.webpackChunktremor_website=self.webpackChunktremor_website||[]).push([[8238],{90579:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>a,contentTitle:()=>i,default:()=>m,frontMatter:()=>o,metadata:()=>p,toc:()=>l});var r=n(58168),s=(n(96540),n(15680));n(40281);const o={},i="HTTP Proxy",p={unversionedId:"recipes/proxies_lt_http/index",id:"version-0.11/recipes/proxies_lt_http/index",title:"HTTP Proxy",description:"All the application code here is available from the docs git repository.",source:"@site/versioned_docs/version-0.11/recipes/32_proxies_lt_http/index.md",sourceDirName:"recipes/32_proxies_lt_http",slug:"/recipes/proxies_lt_http/",permalink:"/docs/0.11/recipes/proxies_lt_http/",draft:!1,editUrl:"https://github.com/tremor-rs/tremor-www/tree/main/versioned_docs/version-0.11/recipes/32_proxies_lt_http/index.md",tags:[],version:"0.11",frontMatter:{},sidebar:"version-0.11/tutorialSidebar",previous:{title:"Websocket Server",permalink:"/docs/0.11/recipes/servers_lt_ws/"},next:{title:"Websocket Proxy",permalink:"/docs/0.11/recipes/proxies_lt_ws/"}},a={},l=[{value:"Setup",id:"setup",level:2},{value:"Sources and sinks",id:"sources-and-sinks",level:3},{value:"Request flow",id:"request-flow",level:3},{value:"Processing logic",id:"processing-logic",level:3},{value:"Testing",id:"testing",level:2}],c={toc:l},d="wrapper";function m(e){let{components:t,...o}=e;return(0,s.yg)(d,(0,r.A)({},c,o,{components:t,mdxType:"MDXLayout"}),(0,s.yg)("h1",{id:"http-proxy"},"HTTP Proxy"),(0,s.yg)("admonition",{type:"note"},(0,s.yg)("p",{parentName:"admonition"},"All the application code here is available from the docs ",(0,s.yg)("a",{parentName:"p",href:"https://github.com/tremor-rs/tremor-www/tree/main/versioned_docs/version-0.11/recipes/32_proxies_lt_http/index.md"},"git repository"),".")),(0,s.yg)("p",null,"Example HTTP proxy application built on top of Tremor and meant to be a demonstration of ",(0,s.yg)("a",{parentName:"p",href:"/docs/0.11/operations/linked-transports"},"linked transports"),"."),(0,s.yg)("h2",{id:"setup"},"Setup"),(0,s.yg)("admonition",{type:"tip"},(0,s.yg)("p",{parentName:"admonition"},"All the code here is available in the ",(0,s.yg)("a",{parentName:"p",href:"https://github.com/tremor-rs/tremor-www/tree/main/docs/recipes/32_proxies_lt_http"},"git repository")," as well.")),(0,s.yg)("h3",{id:"sources-and-sinks"},"Sources and sinks"),(0,s.yg)("p",null,"We configure a rest onramp listening on port 9139, that is meant to be a proxy for our ",(0,s.yg)("a",{parentName:"p",href:"/docs/0.11/recipes/servers_lt_http/"},"example HTTP server")," (configured as en endpoint in the rest offramp here)."),(0,s.yg)("pre",null,(0,s.yg)("code",{parentName:"pre",className:"language-yaml"},"onramp:\n  - id: http\n    type: rest\n    linked: true\n    codec: string\n    config:\n      host: 0.0.0.0\n      port: 9139\n\nofframp:\n  - id: upstream\n    type: rest\n    linked: true\n    codec: string\n    config:\n      endpoint:\n        host: tremor-server\n        port: 8139\n")),(0,s.yg)("h3",{id:"request-flow"},"Request flow"),(0,s.yg)("p",null,"Incoming requests from clients are forwarded to the ",(0,s.yg)("inlineCode",{parentName:"p"},"request_processing")," pipeline, from where it goes to the upstream server. The resulting response is then returned back to the client which initiated the request (after any needed processing from the ",(0,s.yg)("inlineCode",{parentName:"p"},"response_processing")," pipeline)."),(0,s.yg)("pre",null,(0,s.yg)("code",{parentName:"pre",className:"language-yaml"},'binding:\n  - id: main\n    links:\n      # send incoming requests for processing\n      "/onramp/http/{instance}/out":\n        ["/pipeline/request_processing/{instance}/in"]\n\n      # process incoming requests and relay it to upstream\n      "/pipeline/request_processing/{instance}/out":\n        ["/offramp/upstream/{instance}/in"]\n\n      # send the response from upstream for processing\n      "/offramp/upstream/{instance}/out":\n        ["/pipeline/response_processing/{instance}/in"]\n\n      # process upstream response and send it back as a response to incoming\n      "/pipeline/response_processing/{instance}/out":\n        ["/onramp/http/{instance}/in"]\n')),(0,s.yg)("h3",{id:"processing-logic"},"Processing logic"),(0,s.yg)("p",null,"Implementation for the ",(0,s.yg)("inlineCode",{parentName:"p"},"request_processing")," pipeline:"),(0,s.yg)("pre",null,(0,s.yg)("code",{parentName:"pre",className:"language-trickle"},'define script process\nscript\n  # erase the host/port from request url so that requests are routed\n  # to the endpoint configured as part of the rest offramp\n  # can set endpoint concretely here too, depending on the need\n  # (eg: different endpoint based on request path/headers)\n  let $endpoint = patch $request.url of\n    erase "host",\n    erase "port"\n  end;\n  event;\nend;\n\ncreate script process;\n\n# main request processing\nselect event from in into process;\nselect event from process into out;\n\n# tremor runtime errors from the processing script\nselect event from process/err into err;\n')),(0,s.yg)("p",null,"This example demonstrates the minimal processing needed for the proxying logic to work, but you can do any arbitrary processsing on the incoming request as needed (eg: deciding a different upstream based on certain incoming request attributes like headers or request paths)."),(0,s.yg)("p",null,"The ",(0,s.yg)("a",{target:"_blank",href:n(1047).A},"response_processing")," pipeline is similarly minimal -- it adds an entry to the ",(0,s.yg)("inlineCode",{parentName:"p"},"x-powered-by")," header for showing response modifications (if you don't need it, you can use a passthrough pipeline, or even rely on the default ",(0,s.yg)("inlineCode",{parentName:"p"},"system::passthrough")," pipeline which eliminates the need to create this new pipeline)."),(0,s.yg)("h2",{id:"testing"},"Testing"),(0,s.yg)("p",null,"Assuming you have all the code from the ",(0,s.yg)("a",{parentName:"p",href:"https://github.com/tremor-rs/tremor-www/tree/main/docs/recipes/32_proxies_lt_http"},"git repository"),", run the following to start our application (along with the tremor http server example that is the upstream for our proxy):"),(0,s.yg)("pre",null,(0,s.yg)("code",{parentName:"pre",className:"language-sh"},"docker-compose up\n")),(0,s.yg)("p",null,"Now let's try to access an endpoint that we know is available in the upstream server:"),(0,s.yg)("pre",null,(0,s.yg)("code",{parentName:"pre",className:"language-sh"},'# via the proxy. note the additional entry we have in the x-powered-by header\n$ curl -i http://localhost:9139/snot\nHTTP/1.1 200 OK\ncontent-length: 8\nx-powered-by: Tremor, Tremor (As Proxy)\ncontent-type: application/json\ndate: Thu, 15 Oct 2020 05:00:06 GMT\n\n"badger"\n\n\n# the upstream\n$ curl -i http://localhost:8139/snot\nHTTP/1.1 200 OK\ncontent-length: 8\ndate: Thu, 15 Oct 2020 05:00:44 GMT\ncontent-type: application/json\nx-powered-by: Tremor\n\n"badger"\n')),(0,s.yg)("p",null,"All the ",(0,s.yg)("a",{parentName:"p",href:"/docs/0.11/recipes/servers_lt_http/#testing"},"testing examples")," for the example HTTP server should work from here as well, with the port ",(0,s.yg)("inlineCode",{parentName:"p"},"8139")," there swapped to our proxy application port ",(0,s.yg)("inlineCode",{parentName:"p"},"9139"),"."))}m.isMDXComponent=!0},1047:(e,t,n)=>{n.d(t,{A:()=>r});const r=n.p+"assets/files/response_processing-94c9c4cd73b8955fbb9e0e949da92e7f.trickle"}}]);