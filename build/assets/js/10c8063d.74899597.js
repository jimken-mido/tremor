"use strict";(self.webpackChunktremor_website=self.webpackChunktremor_website||[]).push([[1786],{53738:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>s,default:()=>p,frontMatter:()=>r,metadata:()=>o,toc:()=>c});var a=n(58168),i=(n(96540),n(15680));const r={title:"Case Study - Data Flow with Tremor",tags:["case-study","wayfair"],author:"The Tremor Team",author_url:"https://github.com/tremor-rs",author_image_url:"https://avatars.githubusercontent.com/u/60009416?s=200&v=4",image:"./media/wayfair.png",draft:!1,hide_table_of_contents:!1},s="Data Flow with Tremor",o={permalink:"/blog/2021/11/04/data-flow",editUrl:"https://github.com/tremor-rs/tremor-www/tree/main/blog/2021-11-04-data-flow.md",source:"@site/blog/2021-11-04-data-flow.md",title:"Case Study - Data Flow with Tremor",description:"Happened Before",date:"2021-11-04T00:00:00.000Z",formattedDate:"November 4, 2021",tags:[{label:"case-study",permalink:"/blog/tags/case-study"},{label:"wayfair",permalink:"/blog/tags/wayfair"}],readingTime:5.34,hasTruncateMarker:!1,authors:[{name:"The Tremor Team",url:"https://github.com/tremor-rs",imageURL:"https://avatars.githubusercontent.com/u/60009416?s=200&v=4"}],frontMatter:{title:"Case Study - Data Flow with Tremor",tags:["case-study","wayfair"],author:"The Tremor Team",author_url:"https://github.com/tremor-rs",author_image_url:"https://avatars.githubusercontent.com/u/60009416?s=200&v=4",image:"./media/wayfair.png",draft:!1,hide_table_of_contents:!1},prevItem:{title:"Case Study - Kubernetes and Tremor Sidecars",permalink:"/blog/2021/11/05/kubernetes-sidecars"},nextItem:{title:"Case Study - Data Distribution",permalink:"/blog/2021/11/03/data-distribution"}},l={image:n(21697).A,authorsImageUrls:[void 0]},c=[{value:"Happened Before",id:"happened-before",level:2},{value:"Identified Need",id:"identified-need",level:2},{value:"Required Outcome",id:"required-outcome",level:2},{value:"Characteristics",id:"characteristics",level:3},{value:"Solution",id:"solution",level:3},{value:"Conclusion",id:"conclusion",level:2}],d={toc:c},g="wrapper";function p(e){let{components:t,...r}=e;return(0,i.yg)(g,(0,a.A)({},d,r,{components:t,mdxType:"MDXLayout"}),(0,i.yg)("h2",{id:"happened-before"},"Happened Before"),(0,i.yg)("p",null,"The simplified architecture of our systems is currently:  "),(0,i.yg)("p",null,(0,i.yg)("img",{alt:"old pipeline",src:n(86444).A,width:"598",height:"168"})),(0,i.yg)("h2",{id:"identified-need"},"Identified Need"),(0,i.yg)("p",null,"The need to route and process data from multiple sources to multiple\ndestinations with one or many potentially overlapping streams of data\nprocessing is already evident in the first 2 phases of Tremor\u2019s\nemergence as a mission critical piece of infrastructure at Wayfair."),(0,i.yg)("p",null,"Growing adoption and the increased sophistication of processing needs\nnow results in the emergence of event/data flow or pipeline processing\nby our production users. We summarise multiple phases of evolution here\nand conflate them into a single case study.  "),(0,i.yg)("p",null,"In reality the use case captured in this synopsis composes multiple\nsmaller projects related by the same identified need spanning multiple\nreleases into a single case study."),(0,i.yg)("h2",{id:"required-outcome"},"Required Outcome"),(0,i.yg)("p",null,"Our systems specialists are writing increasingly complex, layered and\nrich business logic within tremor\u2019s domain specific language\n",(0,i.yg)("inlineCode",{parentName:"p"},"tremor-script")," and are inhibited by our pipeline model which uses the\nYAML format for describing data flow graphs."),(0,i.yg)("p",null,"YAML is hard to write, and hard to debug, and the embedded scripting\nlanguage is an odd fit into the pipeline configuration which is\ndescribed in YAML."),(0,i.yg)("p",null,"Preserving the internal pipeline processing and execution mechanisms -\nreplace the verbose YAML syntax with a statement oriented query language\nthat extends the expression oriented scripting language.  "),(0,i.yg)("p",null,"This allows hygienic and helpful error reporting with suggested\nworkarounds and fixes, better IDE integration and a more intuitive means\nto express data flow operations on multiple data streams that the\npipeline mechanisms expose to tremor systems application developers.  "),(0,i.yg)("p",null,"A structured query-like language suitably captures the directed-acyclic\ngraph nature of data flows but we need to support rich nested JSON-like\ndata structures with leverage of the processing capabilities of the\nscripting language - whilst opening up new capabilities to extend the\nprocessing capabilities through custom operators, embeddable scripting\nlogic and extensions and enhancements to QoS and non-functional\nprimitives."),(0,i.yg)("p",null,"For the metrics domain - the ability to aggregate tumbling windows of\nevents and to provide multiple aggregation dimensions with flexible\ngrouping policies is a new requirement."),(0,i.yg)("h3",{id:"characteristics"},"Characteristics"),(0,i.yg)("p",null,"Replace the YAML-based pipeline configuration with a structured\nquery-like language that embeds the scripting language, providing top\ngrade support for processing rich data structures, extensibility through\ncustom operators, and windowing semantics to support multi-resolution\nevent aggregation."),(0,i.yg)("p",null,"The initial solution was the introduction of the tremor query language."),(0,i.yg)("h3",{id:"solution"},"Solution"),(0,i.yg)("p",null,"The query language not only replaces the YAML-based event flow syntax\nfor describing data flow pipelines and processing - which is useful for\nevery domain using tremor in production at Wayfair - but, it has special\nconsiderations for the metrics or other analytic domains that require\nrich means of grouping and aggregate processing of in-flight streaming\ndata. The embedding of scripting logic allows the traditional domain of\nETL and data processing and transformation to be natively supported with\na more intuitive syntax."),(0,i.yg)("p",null,"A rate limiting or traffic shaping example ( common to multiple usage\ndomains ):"),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-trickle"},'# File traffic.trickle\n# Very basic traffic shaping algorithm\n\n# Define a bucket grouping operator\ndefine grouper::bucket operator kfc;\n\n# Logic for categorizing events\n\ndefine script categorize\nscript\n  let $rate = 1;\n  let $class = event.`group`;\n  { "event": event, "rate": $rate, "class": $class };\nend;\n\n# An instance of the grouper\ncreate operator kfc from kfc;\n\n# An instance of the categorizer\ncreate script categorize;\n\n# Stream ingested events into the categorizer\nselect event from in into categorize;\n\n# Stream categorized events into the grouper\nselect event from categorize into kfc;\n\n# Stream categorized and group batched events downstream\nselect event from kfc into out;\n')),(0,i.yg)("p",null,"The relatively simple structured query-like language allows script and\nwindow definitions to be reused. The ",(0,i.yg)("inlineCode",{parentName:"p"},"define")," statements do not create\noperator instances in the data flow graph; they create named reusable\ndefinitions that encompass the desired semantics. The ",(0,i.yg)("inlineCode",{parentName:"p"},"create"),"\nstatements create the nodes of the directed acyclic graph. The\n",(0,i.yg)("inlineCode",{parentName:"p"},"select")," statement is a builtin operator that is used for linking\nnodes in the graph together to form a data flow or event processing\ngraph."),(0,i.yg)("p",null,"Although the sample logic in the example is a simplified version of what\nour logging and metrics service teams actually develop and maintain for\nour production systems - it replaces 1000s of lines of cryptic YAML with\nhundreds of lines of easy to debug and reason about query code."),(0,i.yg)("p",null,"An aggregation example from the metrics or analytics domain. This example\nis a complete but simplified example of a tremor event processing application:  "),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-trickle",metastring:'title="aggregator.trickle"',title:'"aggregator.trickle"'},'# Aggregate events using a high dynamic range histogram with 10 second, 1 minute, 10 minute\n# and 1 hour aggregate summaries.*\n\nselect {\n  "measurement": event.measurement,\n  "tags": patch\n    event.tags of insert "window" => window \n  end,\n  # Windowed histogram - for median and a selection of quartiles\n  "stats": aggr::stats::hdr(event.fields[group[2]], [ "0.5","0.9", "0.99", "0.999" ]),\n  "class": group[2],\n  "timestamp": aggr::win::first(event.timestamp),\n}\n# The higher resolution aggregates are merged into lower resolution aggregates to conserve memory\nfrom in[`10secs`, `1min`, `10min`, `1h`]\nwhere event.measurement == "udp_lb"\nor event.measurement == "kafka-proxy.endpoints"\nor event.measurement == "burrow_group"\nor event.measurement == "burrow_partition"\nor event.measurement == "burrow_topic"\n# The operator maintains a user defined composited set of group partitions.\n# Each group maintains its own set of aggregation windows\ngroup by set(event.measurement, event.tags,\neach(record::keys(event.fields)))\ninto normalize\n# Discard computed events with a small sample set\nhaving event.stats.count \\> 100;\n')),(0,i.yg)("p",null,"In most real world tremor-based systems - the synthetic events computed\nin processing pipelines are tailored to conform to the schemas expected\nby multiple downstream systems:  "),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-trickle",metastring:'title="normalize.trickle"',title:'"normalize.trickle"'},'# Prepare computed histogram summaries for downstream systems ( eg: telegraf/influx )\nselect {\n  "measurement": event.measurement,\n  "tags": event.tags,\n  "fields": {\n    "count_#{event.class}": event.stats.count,\n    "min_#{event.class}": event.stats.min,\n    "max_#{event.class}": event.stats.max,\n    "mean_#{event.class}": event.stats.mean,\n    "stdev_#{event.class}": event.stats.stdev,\n    "var_#{event.class}": event.stats.var,\n    "p42_#{event.class}": event.stats.percentiles["0.42"],\n    "p50_#{event.class}": event.stats.percentiles["0.5"],\n    "p90_#{event.class}": event.stats.percentiles["0.9"],\n    "p99_#{event.class}": event.stats.percentiles["0.99"],\n    "p99.9_#{event.class}": event.stats.percentiles["0.999"]\n  }\n}\nfrom normalize\ninto out;\n')),(0,i.yg)("p",null,"Compared to the disparate services and software elements that tremor\nreplaces - the query language affords an intuitive and easy to reason\nabout high level domain specific language to configure rich event\nprocessing and data enrichment and transformation pipelines - with a\nminimally terse yet easy to read form."),(0,i.yg)("h2",{id:"conclusion"},"Conclusion"),(0,i.yg)("p",null,"Tremor\u2019s core mission and mandate includes the efficient declaration of\narbitrarily complex directed-acyclic pipeline processing graphs that are\nmemory and compute efficient under the hood whilst preserving\ntransparency or remaining ",(0,i.yg)("inlineCode",{parentName:"p"},"hidden")," to most of the developers in our\norganization by continuing to conform to external transports, protocols\nand service interfaces in the surrounding production infrastructure\nestate."))}p.isMDXComponent=!0},86444:(e,t,n)=>{n.d(t,{A:()=>a});const a=n.p+"assets/images/image1-546e9398e3b74c01fefca8fa7450da0e.png"},21697:(e,t,n)=>{n.d(t,{A:()=>a});const a=n.p+"assets/images/wayfair-b0bafac5cf230fcd5e29c8cb4560c334.png"}}]);