"use strict";(self.webpackChunktremor_website=self.webpackChunktremor_website||[]).push([[109],{98366:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>s,default:()=>c,frontMatter:()=>r,metadata:()=>o,toc:()=>p});var a=n(58168),i=(n(96540),n(15680));n(40281);const r={},s="Transform",o={unversionedId:"recipes/transform/index",id:"version-0.11/recipes/transform/index",title:"Transform",description:"All the application code here is available from the docs git repository.",source:"@site/versioned_docs/version-0.11/recipes/02_transform/index.md",sourceDirName:"recipes/02_transform",slug:"/recipes/transform/",permalink:"/docs/0.11/recipes/transform/",draft:!1,editUrl:"https://github.com/tremor-rs/tremor-www/tree/main/versioned_docs/version-0.11/recipes/02_transform/index.md",tags:[],version:"0.11",frontMatter:{},sidebar:"version-0.11/tutorialSidebar",previous:{title:"Filter",permalink:"/docs/0.11/recipes/filter/"},next:{title:"Validate",permalink:"/docs/0.11/recipes/validate/"}},l={},p=[{value:"Environment",id:"environment",level:2},{value:"Business Logic",id:"business-logic",level:2},{value:"Command line testing during logic development",id:"command-line-testing-during-logic-development",level:2},{value:"Discussion",id:"discussion",level:3},{value:"Examples",id:"examples",level:3},{value:"Templating percentile estimates from HDR Histogram",id:"templating-percentile-estimates-from-hdr-histogram",level:4}],m={toc:p},g="wrapper";function c(e){let{components:t,...r}=e;return(0,i.yg)(g,(0,a.A)({},m,r,{components:t,mdxType:"MDXLayout"}),(0,i.yg)("h1",{id:"transform"},"Transform"),(0,i.yg)("admonition",{type:"note"},(0,i.yg)("p",{parentName:"admonition"},"All the application code here is available from the docs ",(0,i.yg)("a",{parentName:"p",href:"https://github.com/tremor-rs/tremor-www/tree/main/versioned_docs/version-0.11/recipes/02_transform/index.md"},"git repository"),".")),(0,i.yg)("p",null,"The ",(0,i.yg)("inlineCode",{parentName:"p"},"transform")," example builds on the ",(0,i.yg)("a",{parentName:"p",href:"/docs/0.11/recipes/filter/"},"filter example")," and extends the ",(0,i.yg)("a",{target:"_blank",href:n(19511).A},(0,i.yg)("code",null,"example.trickle"))," by adding a transformation that modifies the incoming event. The produced event from this query statement has a different structure than the incoming event."),(0,i.yg)("h2",{id:"environment"},"Environment"),(0,i.yg)("p",null,"It connects to the pipeline ",(0,i.yg)("inlineCode",{parentName:"p"},"example")," in the ",(0,i.yg)("a",{target:"_blank",href:n(19511).A},(0,i.yg)("code",null,"example.trickle"))," file using the tremor script language to change the json for the log."),(0,i.yg)("p",null,"All other configuration is the same as per the passthrough example, and is elided here for brevity."),(0,i.yg)("h2",{id:"business-logic"},"Business Logic"),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-trickle"},'select {                                     # 1. We can inline new json-like document structures\n    "hello": "hi there #{event.hello}",      # 2. Tremor supports flexible string interpolation useful for templating\n    "world": event.hello\n} from in where event.selected into out\n')),(0,i.yg)("h2",{id:"command-line-testing-during-logic-development"},"Command line testing during logic development"),(0,i.yg)("p",null,"Run a the passthrough query against a sample input.json"),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-bash"},'$ cat input.json \n{ "hello": "world", "selected": false }\n\n# no output\n$ tremor run -i input.json ./etc/tremor/config/example.trickle\n$\n')),(0,i.yg)("p",null,"Change the ",(0,i.yg)("inlineCode",{parentName:"p"},"input.json")," and toggle the ",(0,i.yg)("inlineCode",{parentName:"p"},"selected")," field to ",(0,i.yg)("inlineCode",{parentName:"p"},"true")," and run again."),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-bash"},'$ cat input.json \n{ "hello": "world", "selected": true }\n\n$ tremor run -i input.json ./etc/tremor/config/example.trickle\n{"hello":"hi there world","world":"world"}\n')),(0,i.yg)("p",null,"Deploy the solution into a docker environment - ",(0,i.yg)("inlineCode",{parentName:"p"},"docker-compose up"),"."),(0,i.yg)("p",null,"In a separate terminal, inject test messages via ",(0,i.yg)("a",{parentName:"p",href:"https://github.com/vi/websocat"},"websocat")),(0,i.yg)("admonition",{type:"note"},(0,i.yg)("p",{parentName:"admonition"},"Can be installed via ",(0,i.yg)("inlineCode",{parentName:"p"},"cargo install websocat")," for the lazy/impatient amongst us")),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-bash"},"$ cat inputs.txt | websocat ws://localhost:4242\n...\n")),(0,i.yg)("p",null,"You should see this message in the terminal where you are running ",(0,i.yg)("inlineCode",{parentName:"p"},"docker-compose"),":"),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-bash"},'...\n>> {"hello":"hi there again","world":"again"}\n')),(0,i.yg)("h3",{id:"discussion"},"Discussion"),(0,i.yg)("p",null,"Transformations in tremor query ( ",(0,i.yg)("inlineCode",{parentName:"p"},"trickle")," ) can be any legal type / value supported\nby the tremor family of languages:"),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},"A boolean value"),(0,i.yg)("li",{parentName:"ul"},"An integer"),(0,i.yg)("li",{parentName:"ul"},"A floating point value"),(0,i.yg)("li",{parentName:"ul"},"A UTF-8 encoded string"),(0,i.yg)("li",{parentName:"ul"},"An array of any legal value"),(0,i.yg)("li",{parentName:"ul"},"A record of field / value pairs where the field name is a string, and the value is any legal value")),(0,i.yg)("h3",{id:"examples"},"Examples"),(0,i.yg)("h4",{id:"templating-percentile-estimates-from-hdr-histogram"},"Templating percentile estimates from HDR Histogram"),(0,i.yg)("p",null,"In this example, we restructure output from the tremor ",(0,i.yg)("inlineCode",{parentName:"p"},"aggr::stats::hdr")," aggregate function\nand use string interpolation to generate record templates with a field naming scheme and\nstructure this is compatible with tremor's influx data offramp."),(0,i.yg)("p",null,"A nice advantage of tremor, is that the business logic is separate from any externalising\nfactors. However, one drawback with unstructured transformations is there is no\nexplicit validation by schema supported by tremor out of the box - although, there are\npatterns in use to validate against external schema formats in use in production."),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-trickle"},'select {\n  "measurement":  event.measurement,\n  "tags":  event.tags,\n  "timestamp": event.timestamp,\n  "fields":  {\n    # the following fields are generated by templating / string interpolation\n    "count_#{event.class}":  event.stats.count,\n    "min_#{event.class}":  event.stats.min,\n    "max_#{event.class}":  event.stats.max,\n    "mean_#{event.class}":  event.stats.mean,\n    "stdev_#{event.class}":  event.stats.stdev,\n    "var_#{event.class}":  event.stats.var,\n    "p50_#{event.class}":  event.stats.percentiles["0.5"],\n    "p90_#{event.class}":  event.stats.percentiles["0.9"],\n    "p99_#{event.class}":  event.stats.percentiles["0.99"],\n    "p99.9_#{event.class}":  event.stats.percentiles["0.999"]\n  }\n}\nfrom normalize\ninto batch;\n')),(0,i.yg)("admonition",{type:"tip"},(0,i.yg)("p",{parentName:"admonition"},"Not all tremor script idioms are allowed in the ",(0,i.yg)("inlineCode",{parentName:"p"},"select")," statement. Most notably we do not allow any mutating operations such as ",(0,i.yg)("inlineCode",{parentName:"p"},"let")," or control flow such as ",(0,i.yg)("inlineCode",{parentName:"p"},"emit")," or ",(0,i.yg)("inlineCode",{parentName:"p"},"drop"),". Those constructs can however still be used inside a ",(0,i.yg)("inlineCode",{parentName:"p"},"script")," block on their own.")))}c.isMDXComponent=!0},19511:(e,t,n)=>{n.d(t,{A:()=>a});const a=n.p+"assets/files/example-f4d39b91cf83b649304c8f93c1e79821.trickle"}}]);