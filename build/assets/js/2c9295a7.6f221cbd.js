"use strict";(self.webpackChunktremor_website=self.webpackChunktremor_website||[]).push([[9637],{19397:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>l,default:()=>p,frontMatter:()=>i,metadata:()=>o,toc:()=>s});var a=t(58168),r=(t(96540),t(15680));t(40281);const i={sidebar_label:"elastic (Elastic Search)",sidebar_position:1},l="The elastic Connector",o={unversionedId:"reference/connectors/elastic",id:"version-0.12/reference/connectors/elastic",title:"The elastic Connector",description:"The elastic connector integrates ElasticSearch and compatible systems with tremor.",source:"@site/versioned_docs/version-0.12/reference/connectors/elastic.md",sourceDirName:"reference/connectors",slug:"/reference/connectors/elastic",permalink:"/docs/0.12/reference/connectors/elastic",draft:!1,editUrl:"https://github.com/tremor-rs/tremor-www/tree/main/versioned_docs/version-0.12/reference/connectors/elastic.md",tags:[],version:"0.12",sidebarPosition:1,frontMatter:{sidebar_label:"elastic (Elastic Search)",sidebar_position:1},sidebar:"indexSidebar",previous:{title:"dns (DNS Lookup)",permalink:"/docs/0.12/reference/connectors/dns"},next:{title:"file",permalink:"/docs/0.12/reference/connectors/file"}},c={},s=[{value:"Configuration",id:"configuration",level:2},{value:"Example",id:"example",level:3},{value:"A batch upload service to elasticsearch",id:"a-batch-upload-service-to-elasticsearch",level:2}],d={toc:s},g="wrapper";function p(e){let{components:n,...t}=e;return(0,r.yg)(g,(0,a.A)({},d,t,{components:n,mdxType:"MDXLayout"}),(0,r.yg)("h1",{id:"the-elastic-connector"},"The ",(0,r.yg)("inlineCode",{parentName:"h1"},"elastic")," Connector"),(0,r.yg)("p",null,"The ",(0,r.yg)("inlineCode",{parentName:"p"},"elastic")," connector integrates ElasticSearch and compatible systems with tremor."),(0,r.yg)("p",null,"Tested with ElasticSearch ",(0,r.yg)("inlineCode",{parentName:"p"},"v6")," and ",(0,r.yg)("inlineCode",{parentName:"p"},"v7")," and OpenSearch ",(0,r.yg)("inlineCode",{parentName:"p"},"v1.3.1")),(0,r.yg)("p",null,"Events will be sent to the connected ElasticSearch compatible cluster via the ",(0,r.yg)("a",{parentName:"p",href:"https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-bulk.html"},"ES Bulk API"),"\nusing the ",(0,r.yg)("inlineCode",{parentName:"p"},"index")," action by default.  It is recommended to batch events sent to this sink using the ",(0,r.yg)("a",{parentName:"p",href:"/docs/0.12/reference/operators/batch"},(0,r.yg)("inlineCode",{parentName:"a"},"generic::batch")," operator")," to reduce the overhead introduced by the ",(0,r.yg)("a",{parentName:"p",href:"https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-bulk.html"},"ES Bulk API"),"."),(0,r.yg)("admonition",{type:"note"},(0,r.yg)("p",{parentName:"admonition"},"The configuration options ",(0,r.yg)("inlineCode",{parentName:"p"},"codec")," and ",(0,r.yg)("inlineCode",{parentName:"p"},"postprocessors")," are not used, as elastic will always serialize event payloads as JSON.")),(0,r.yg)("p",null,"If the number of parallel requests surpass ",(0,r.yg)("inlineCode",{parentName:"p"},"concurrency"),", the connector will trigger the ",(0,r.yg)("a",{parentName:"p",href:"/docs/0.12/concepts/runtime_capabilities#the-circuit-breaker-mechanism"},"circuit breaker")," in order to stop events from flowing in. It will restore it again when it regains capacity."),(0,r.yg)("p",null,"The following metadata variables can be specified on a per event basis as fields under the ",(0,r.yg)("inlineCode",{parentName:"p"},"elastic")," namespace:"),(0,r.yg)("table",null,(0,r.yg)("thead",{parentName:"table"},(0,r.yg)("tr",{parentName:"thead"},(0,r.yg)("th",{parentName:"tr",align:null},"Variable"),(0,r.yg)("th",{parentName:"tr",align:null},"Description"),(0,r.yg)("th",{parentName:"tr",align:null},"Type"),(0,r.yg)("th",{parentName:"tr",align:null},"Required"),(0,r.yg)("th",{parentName:"tr",align:null},"Default value"))),(0,r.yg)("tbody",{parentName:"table"},(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},"action"),(0,r.yg)("td",{parentName:"tr",align:null},"The ",(0,r.yg)("a",{parentName:"td",href:"https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-bulk.html"},"bulk action")," to perform, one of ",(0,r.yg)("inlineCode",{parentName:"td"},"delete"),", ",(0,r.yg)("inlineCode",{parentName:"td"},"create"),", ",(0,r.yg)("inlineCode",{parentName:"td"},"update")," or ",(0,r.yg)("inlineCode",{parentName:"td"},"index"),". ",(0,r.yg)("inlineCode",{parentName:"td"},"delete")," and ",(0,r.yg)("inlineCode",{parentName:"td"},"update")," require ",(0,r.yg)("inlineCode",{parentName:"td"},"$elastic._id")," to be set or elastic search will have error."),(0,r.yg)("td",{parentName:"tr",align:null},"String"),(0,r.yg)("td",{parentName:"tr",align:null},"no"),(0,r.yg)("td",{parentName:"tr",align:null},(0,r.yg)("inlineCode",{parentName:"td"},"index"))),(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},"_index"),(0,r.yg)("td",{parentName:"tr",align:null},"The index to write to."),(0,r.yg)("td",{parentName:"tr",align:null},"String"),(0,r.yg)("td",{parentName:"tr",align:null},"not if specified in connector ",(0,r.yg)("a",{parentName:"td",href:"#configuration"},"configuration")),(0,r.yg)("td",{parentName:"tr",align:null},(0,r.yg)("inlineCode",{parentName:"td"},"index")," from connector ",(0,r.yg)("a",{parentName:"td",href:"#configuration"},"configuration"))),(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},"_type"),(0,r.yg)("td",{parentName:"tr",align:null},"The document type for elastic, deprecated in ES 7."),(0,r.yg)("td",{parentName:"tr",align:null},"String"),(0,r.yg)("td",{parentName:"tr",align:null},"no"),(0,r.yg)("td",{parentName:"tr",align:null},(0,r.yg)("inlineCode",{parentName:"td"},"_doc"))),(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},"_id"),(0,r.yg)("td",{parentName:"tr",align:null},"The document id for elastic. If not provided ES generates an id."),(0,r.yg)("td",{parentName:"tr",align:null},"String"),(0,r.yg)("td",{parentName:"tr",align:null},"no"),(0,r.yg)("td",{parentName:"tr",align:null})),(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},"pipeline"),(0,r.yg)("td",{parentName:"tr",align:null},"The elasticsearch pipeline to use."),(0,r.yg)("td",{parentName:"tr",align:null},"String"),(0,r.yg)("td",{parentName:"tr",align:null},"no"),(0,r.yg)("td",{parentName:"tr",align:null})),(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},"raw_payload"),(0,r.yg)("td",{parentName:"tr",align:null},"By default, if the ",(0,r.yg)("inlineCode",{parentName:"td"},"update")," action is used, the event payload is considered as the partial document for update, by wrapping it inside the ",(0,r.yg)("inlineCode",{parentName:"td"},"doc")," field. Setting this field to ",(0,r.yg)("inlineCode",{parentName:"td"},"true")," will take the event payload as is. This allows to specify ",(0,r.yg)("a",{parentName:"td",href:"https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-update.html#update-api-example"},(0,r.yg)("inlineCode",{parentName:"a"},"script")),", ",(0,r.yg)("a",{parentName:"td",href:"https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-update.html#doc_as_upsert"},(0,r.yg)("inlineCode",{parentName:"a"},"doc_as_upsert"))," and more fields."),(0,r.yg)("td",{parentName:"tr",align:null},"bool"),(0,r.yg)("td",{parentName:"tr",align:null},"no"),(0,r.yg)("td",{parentName:"tr",align:null},"false")),(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},"routing"),(0,r.yg)("td",{parentName:"tr",align:null},"Routing information for elasticsearch. See their docs on ",(0,r.yg)("a",{parentName:"td",href:"https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-bulk.html#bulk-routing"},"bulk routing")),(0,r.yg)("td",{parentName:"tr",align:null},"String"),(0,r.yg)("td",{parentName:"tr",align:null},"no"),(0,r.yg)("td",{parentName:"tr",align:null})),(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},"timeout"),(0,r.yg)("td",{parentName:"tr",align:null},"Timeout to wait for operations within elasticsearch (index creation, mapping updates, waiting for active shards)"),(0,r.yg)("td",{parentName:"tr",align:null},(0,r.yg)("a",{parentName:"td",href:"https://www.elastic.co/guide/en/elasticsearch/reference/current/api-conventions.html#time-units"},"elasticsearch time unit")),(0,r.yg)("td",{parentName:"tr",align:null},"no"),(0,r.yg)("td",{parentName:"tr",align:null},(0,r.yg)("inlineCode",{parentName:"td"},"1m")," (one minute)")),(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},"refresh"),(0,r.yg)("td",{parentName:"tr",align:null},"Refresh the affected shards and make this operation visible to search"),(0,r.yg)("td",{parentName:"tr",align:null},(0,r.yg)("inlineCode",{parentName:"td"},"true"),", ",(0,r.yg)("inlineCode",{parentName:"td"},"false"),", ",(0,r.yg)("inlineCode",{parentName:"td"},'"wait_for"')),(0,r.yg)("td",{parentName:"tr",align:null},"no"),(0,r.yg)("td",{parentName:"tr",align:null},(0,r.yg)("inlineCode",{parentName:"td"},"false"))),(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},"version"),(0,r.yg)("td",{parentName:"tr",align:null},"Set a custom version manually. See ",(0,r.yg)("a",{parentName:"td",href:"https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-bulk.html#bulk-versioning"},"bulk versioning"),"."),(0,r.yg)("td",{parentName:"tr",align:null},"unsigned integer"),(0,r.yg)("td",{parentName:"tr",align:null},"no"),(0,r.yg)("td",{parentName:"tr",align:null})),(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},"version_type"),(0,r.yg)("td",{parentName:"tr",align:null},"See ",(0,r.yg)("a",{parentName:"td",href:"https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-bulk.html#bulk-versioning"},"bulk versioning"),"."),(0,r.yg)("td",{parentName:"tr",align:null},"See ",(0,r.yg)("a",{parentName:"td",href:"https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-index_.html#index-version-types"},"elasticsearch version types"),"."),(0,r.yg)("td",{parentName:"tr",align:null},"no"),(0,r.yg)("td",{parentName:"tr",align:null})),(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},"retry_on_conflict"),(0,r.yg)("td",{parentName:"tr",align:null},"The number of retries to execute in case of a version conflict."),(0,r.yg)("td",{parentName:"tr",align:null},"unsigned integer"),(0,r.yg)("td",{parentName:"tr",align:null},"no"),(0,r.yg)("td",{parentName:"tr",align:null},(0,r.yg)("inlineCode",{parentName:"td"},"0"))),(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},"if_primary_term"),(0,r.yg)("td",{parentName:"tr",align:null},"See ",(0,r.yg)("a",{parentName:"td",href:"https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-bulk.html#bulk-optimistic-concurrency-control"},"optimistic concurrency control")),(0,r.yg)("td",{parentName:"tr",align:null},"unsigned integer"),(0,r.yg)("td",{parentName:"tr",align:null},"no"),(0,r.yg)("td",{parentName:"tr",align:null})),(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},"if_seq_no"),(0,r.yg)("td",{parentName:"tr",align:null},"See ",(0,r.yg)("a",{parentName:"td",href:"https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-bulk.html#bulk-optimistic-concurrency-control"},"optimistic concurrency control")),(0,r.yg)("td",{parentName:"tr",align:null},"unsigned integer"),(0,r.yg)("td",{parentName:"tr",align:null},"no"),(0,r.yg)("td",{parentName:"tr",align:null})))),(0,r.yg)("p",null,"The following example shows a way how to specify the necessary metadata for elasticsearch:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-tremor"},'define script prepare_for_elastic\nargs\n  index\nscript\n  let $elastic = {\n    "action": "update",\n    "_id": event["_id"],\n    "_index": args.index,\n    "retry_on_conflict": 3,\n    "refresh": true,\n    "timeout": "30s"\n  };\n  emit event["payload"];\nend;\n')),(0,r.yg)("h2",{id:"configuration"},"Configuration"),(0,r.yg)("table",null,(0,r.yg)("thead",{parentName:"table"},(0,r.yg)("tr",{parentName:"thead"},(0,r.yg)("th",{parentName:"tr",align:null},"Option"),(0,r.yg)("th",{parentName:"tr",align:null},"Description"),(0,r.yg)("th",{parentName:"tr",align:null},"Type"),(0,r.yg)("th",{parentName:"tr",align:null},"Required"),(0,r.yg)("th",{parentName:"tr",align:null},"Default value"))),(0,r.yg)("tbody",{parentName:"table"},(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},"nodes"),(0,r.yg)("td",{parentName:"tr",align:null},"List of URLs to elasticsearch cluster nodes"),(0,r.yg)("td",{parentName:"tr",align:null},"array of strings"),(0,r.yg)("td",{parentName:"tr",align:null},"yes"),(0,r.yg)("td",{parentName:"tr",align:null})),(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},"index"),(0,r.yg)("td",{parentName:"tr",align:null},"Elasticsearch index to operate on. Can be overwritten by event metadata ",(0,r.yg)("inlineCode",{parentName:"td"},'$elastic["_index"]')),(0,r.yg)("td",{parentName:"tr",align:null},"string"),(0,r.yg)("td",{parentName:"tr",align:null},"no"),(0,r.yg)("td",{parentName:"tr",align:null})),(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},"concurrency"),(0,r.yg)("td",{parentName:"tr",align:null},"The maximum number of in-flight requests"),(0,r.yg)("td",{parentName:"tr",align:null},"unsigned integer"),(0,r.yg)("td",{parentName:"tr",align:null},"no"),(0,r.yg)("td",{parentName:"tr",align:null},"4")),(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},"include_payload_in_response"),(0,r.yg)("td",{parentName:"tr",align:null},"Whether or not to include the whole event payload in ES success and error responses emitted via ",(0,r.yg)("inlineCode",{parentName:"td"},"out")," and ",(0,r.yg)("inlineCode",{parentName:"td"},"err")," ports"),(0,r.yg)("td",{parentName:"tr",align:null},"boolean"),(0,r.yg)("td",{parentName:"tr",align:null},"no"),(0,r.yg)("td",{parentName:"tr",align:null},"false")),(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},"headers"),(0,r.yg)("td",{parentName:"tr",align:null},"HTTP headers to add to each request to elasticsearch"),(0,r.yg)("td",{parentName:"tr",align:null},"record with string values"),(0,r.yg)("td",{parentName:"tr",align:null},"no"),(0,r.yg)("td",{parentName:"tr",align:null})),(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},"auth"),(0,r.yg)("td",{parentName:"tr",align:null},"Authorization method to use for each HTTP request. See ",(0,r.yg)("a",{parentName:"td",href:"/docs/0.12/reference/connectors/common_configuration#auth"},(0,r.yg)("inlineCode",{parentName:"a"},"auth")," config"),"."),(0,r.yg)("td",{parentName:"tr",align:null},"See ",(0,r.yg)("a",{parentName:"td",href:"/docs/0.12/reference/connectors/common_configuration#auth"},(0,r.yg)("inlineCode",{parentName:"a"},"auth")," config"),"."),(0,r.yg)("td",{parentName:"tr",align:null},"no"),(0,r.yg)("td",{parentName:"tr",align:null})),(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},"tls"),(0,r.yg)("td",{parentName:"tr",align:null},"Enable TLS encrypted traffic to elasticsearch. Specify a custom CA certificate chain or make use of client-side certificates."),(0,r.yg)("td",{parentName:"tr",align:null},"See",(0,r.yg)("a",{parentName:"td",href:"/docs/0.12/reference/connectors/common_configuration#client"},(0,r.yg)("inlineCode",{parentName:"a"},"tls")," client config")),(0,r.yg)("td",{parentName:"tr",align:null},"no"),(0,r.yg)("td",{parentName:"tr",align:null})),(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},"timeout"),(0,r.yg)("td",{parentName:"tr",align:null},"HTTP request timeout in nanoseconds"),(0,r.yg)("td",{parentName:"tr",align:null},"unsigned integer"),(0,r.yg)("td",{parentName:"tr",align:null},"no"),(0,r.yg)("td",{parentName:"tr",align:null},"By default no timeout is specified.")))),(0,r.yg)("h3",{id:"example"},"Example"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-tremor",metastring:'title="config.troy"',title:'"config.troy"'},'  define connector elastic from elastic\n  with\n    config = {\n      "nodes": ["http://127.0.0.1:9200/"],\n      "concurrency": 10,\n      # When true, attaches request payload to response event\n      "include_payload_in_response": true\n      index = "my_index",\n      # authenticate using an elasticsearch api key\n      auth = {\n        "elastic_api_key": {\n          "id": "ZSHpKIEBc6SDIeISiRsT",\n          "api_key": "1lqrzNhRSUWmzuQqy333yw"\n        }\n      }\n    }\n  end;\n')),(0,r.yg)("h2",{id:"a-batch-upload-service-to-elasticsearch"},"A batch upload service to elasticsearch"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-tremor"},'define flow main\nflow\n  use std::time::nanos;\n  use integration;\n  use tremor::pipelines;\n  use tremor::connectors;\n\n  define pipeline main\n  pipeline\n  define\n    script process_batch_item\n    script\n      # setting required metadata for elastic\n      let $elastic = {\n        "_index": "my_little_index",\n        "action": event.action,\n      };\n      let $correlation = event.snot;\n      match event of\n        case %{present doc_id} => let $elastic["_id"] = event.doc_id\n        default => null\n      end;\n      event\n    end;\n    create script process_batch_item;\n\n    define operator batch from generic::batch with\n      count = 6\n    end;\n    create operator batch;\n\n    define script process_whole_batch\n    script\n      let $elastic = {\n        "_type": "my_little_doc"\n      };\n      event\n    end;\n    create script process_whole_batch;\n\n    select event from in into process_batch_item;\n    select event from process_batch_item into batch;\n    select event from batch into process_whole_batch;\n    select event from process_whole_batch into out;\n    select event from process_batch_item/err into err;\n    select event from process_whole_batch/err into err;\n  end;\n\n  define pipeline response_handling\n  into out, exit, err\n  pipeline\n    select {\n      "action": $elastic.action,\n      "success": $elastic.success,\n      "payload": event.payload,\n      "index": $elastic["_index"],\n      "doc": $elastic["_type"],\n      "correlation": $correlation\n    }\n    from in where $elastic.success == true into out;\n\n    select {\n      "action": $elastic.action,\n      "payload": event.payload,\n      "success": $elastic.success,\n      "index": $elastic["_index"],\n      "doc": $elastic["_type"],\n      "correlation": $correlation\n    }\n    from in where $elastic.success == false into err;\n\n    select "exit" from in where match event.payload of case %{ present exit } => true default => false end into exit;\n  end;\n\n  define connector elastic from elastic\n  with\n    config = {\n      "nodes": ["http://127.0.0.1:9200/"],\n      "concurrency": 10,\n      "include_payload_in_response": true\n    }\n  end;\n\n  create connector input from integration::read_file;\n  create connector errfile from integration::write_file\n  with\n    file = "err.log"\n  end;\n  create connector okfile from integration::write_file\n  with\n    file = "ok.log"\n  end;\n  create connector exit from integration::exit;\n  create connector stdio from connectors::console;\n  create connector elastic;\n\n  create pipeline main;\n  create pipeline response_handling;\n\n\n  connect /connector/input/out to /pipeline/main/in;\n  connect /pipeline/main/out to /connector/elastic/in;\n  connect /connector/elastic/out to /pipeline/response_handling/in;\n  connect /pipeline/response_handling/out to /connector/okfile/in;\n  connect /pipeline/response_handling/out to /connector/stdio/in;\n  connect /pipeline/response_handling/exit to /connector/exit/in;\n  connect /connector/elastic/err to /pipeline/response_handling/in;\n  connect /pipeline/response_handling/err to /connector/errfile/in;\n  connect /pipeline/response_handling/err to /connector/stdio/in;\nend;\n\ndeploy flow main;\n')))}p.isMDXComponent=!0}}]);