"use strict";(self.webpackChunktremor_website=self.webpackChunktremor_website||[]).push([[8818],{97489:(e,t,o)=>{o.r(t),o.d(t,{assets:()=>l,contentTitle:()=>s,default:()=>g,frontMatter:()=>n,metadata:()=>i,toc:()=>c});var a=o(58168),r=(o(96540),o(15680));o(40281);const n={},s="Quota Service",i={unversionedId:"recipes/quota_service/index",id:"version-0.11/recipes/quota_service/index",title:"Quota Service",description:"All the application code here is available from the docs git repository.",source:"@site/versioned_docs/version-0.11/recipes/36_quota_service/index.md",sourceDirName:"recipes/36_quota_service",slug:"/recipes/quota_service/",permalink:"/docs/0.11/recipes/quota_service/",draft:!1,editUrl:"https://github.com/tremor-rs/tremor-www/tree/main/versioned_docs/version-0.11/recipes/36_quota_service/index.md",tags:[],version:"0.11",frontMatter:{},sidebar:"version-0.11/tutorialSidebar",previous:{title:"Reverse proxy with Load Balancing",permalink:"/docs/0.11/recipes/reverse_proxy_load_balancing/"},next:{title:"Configurator",permalink:"/docs/0.11/recipes/configurator/"}},l={},c=[{value:"Setup",id:"setup",level:2},{value:"Log Ingestion",id:"log-ingestion",level:2},{value:"Using the Quota Service",id:"using-the-quota-service",level:2}],p={toc:c},u="wrapper";function g(e){let{components:t,...n}=e;return(0,r.yg)(u,(0,a.A)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,r.yg)("h1",{id:"quota-service"},"Quota Service"),(0,r.yg)("admonition",{type:"note"},(0,r.yg)("p",{parentName:"admonition"},"All the application code here is available from the docs ",(0,r.yg)("a",{parentName:"p",href:"https://github.com/tremor-rs/tremor-www/tree/main/versioned_docs/version-0.11/recipes/36_quota_service/index.md"},"git repository"),".")),(0,r.yg)("p",null,"Demo quota service, geared for a log collection usecase (but can be applied for similar needs elsewhere too)."),(0,r.yg)("p",null,"This is a HTTP CRUD application running alongside an example log receiver setup (logs in via TCP -> tremor -> elastic out), that allows operators to update the throttling rates for various classes of logs. It also allows retrieving the current quotas for all classes, which can potentially be used by logging clients to pre-throttle on their end, even before transmitting the logs to tremor (or the information can be used to always provide up-to-date quota limits to folks using this log platform)."),(0,r.yg)("p",null,"The application itself is written on top of tremor, utilizing the ",(0,r.yg)("a",{parentName:"p",href:"/docs/0.11/operations/linked-transports"},"linked transports")," feature introduced in Tremor 0.9 and the ",(0,r.yg)("a",{parentName:"p",href:"/docs/0.11/artefacts/offramps#kv"},"KV offramp")," introduced in Tremor 0.11."),(0,r.yg)("h2",{id:"setup"},"Setup"),(0,r.yg)("admonition",{type:"note"},(0,r.yg)("p",{parentName:"admonition"},"All the application code here is available from the docs ",(0,r.yg)("a",{parentName:"p",href:"https://github.com/tremor-rs/tremor-www/tree/main/docs/recipes/36_quota_service"},"git repository"),".")),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-sh"},"# needed for elasticsearch container to start successfully\n# https://www.elastic.co/guide/en/elasticsearch/reference/current/docker.html#_set_vm_max_map_count_to_at_least_262144\nsudo sysctl -w vm.max_map_count=262144\n\n# start everything (tremor/elasticsearch/kibana)\ndocker-compose up\n")),(0,r.yg)("p",null,"Following services should now be accessible:"),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},"Quota Service: (Tremor) ",(0,r.yg)("a",{parentName:"li",href:"http://localhost:8139"},"http://locahost:8139")),(0,r.yg)("li",{parentName:"ul"},"Log receiver (Tremor): tcp://localhost:12202"),(0,r.yg)("li",{parentName:"ul"},"Elasticsearch: ",(0,r.yg)("a",{parentName:"li",href:"http://localhost:9200"},"http://locahost:9200")),(0,r.yg)("li",{parentName:"ul"},"Kibana: ",(0,r.yg)("a",{parentName:"li",href:"http://localhost:5601/"},"http://localhost:5601/"))),(0,r.yg)("h2",{id:"log-ingestion"},"Log Ingestion"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-sh"},"# send logs periodically to the tcp log receiver port (powered by tremor)\n./logger.sh | nc localhost 12202\n")),(0,r.yg)("p",null,"You should now see an elasticsearch index (",(0,r.yg)("inlineCode",{parentName:"p"},"test_logs"),") being created with the logs. Example:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre"},"$ curl localhost:9200/_cat/indices\nyellow open test_logs xtdBODqGQ7Gub1PfUlcaWA 5 1 788 0  139kb  139kb\n")),(0,r.yg)("p",null,"You can also inspect/visualize the logs from kibana. Create an index pattern ",(0,r.yg)("a",{parentName:"p",href:"http://localhost:5601/app/kibana#/management/kibana/index"},"here")," (eg: ",(0,r.yg)("inlineCode",{parentName:"p"},"test_logs*"),"), choosing ",(0,r.yg)("inlineCode",{parentName:"p"},"ingestion_timestamp")," as the time field -- this allows timeseries navigation in the ",(0,r.yg)("a",{parentName:"p",href:"http://localhost:5601/app/kibana#/discover"},"Discover")," page as the logs are ingested (useful since we are replaying old log data dump)."),(0,r.yg)("h2",{id:"using-the-quota-service"},"Using the Quota Service"),(0,r.yg)("p",null,(0,r.yg)("strong",{parentName:"p"},"List routes")),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-sh"},"$ curl http://localhost:8139\n\n      Welcome to the Logging Quota Service!\n\n      Available routes:\n\n      GET /quotas\n      GET /quotas/<quota_name>\n      PUT /quotas/<quota_name>\n      DELETE /quotas/<quota_name>\n\n      HEAD /ping\n\n      * /echo\n")),(0,r.yg)("p",null,(0,r.yg)("strong",{parentName:"p"},"Get quotas")),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-sh"},'# populated from file etc/tremor/data/quotas.json on startup\n# output is keyed by class name (the details of the classification are defined in etc/tremor/config/logs.trickle)\n$ curl -XGET localhost:8139/quotas\n\n{"host_default":500,"logger_default":50,"index_default":100,"tremolo":100,"application_default":100}\n\n# it is also possible to get single quotas\n$ curl -XGET localhost:8139/quotas/index_default\n\n{"index_default":100}\n')),(0,r.yg)("p",null,(0,r.yg)("strong",{parentName:"p"},"Set quotas")),(0,r.yg)("p",null,"Changes to quotas are applied immediately, no scheduled reads of the quotas are necessary, no downtime to change configuration is required. What we get is updated quota handling in real-time:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-sh"},"# set rate for tremolo class of logs to 1 message per second\n# returns the old, overwritten state on success\n$ curl -XPUT -H'Content-Type: application/json' \"http://localhost:8139/quotas/tremolo\" -d'1'\n\n{\"tremolo\": 100}\n\n# If you are monitoring the tremolo logs from kibana, you should now see the (debug) field `tremor_class_rate` change to 1 (from 100).\n# More importantly, the log volume visible there should have also decreased.\n\n# to remove the rate override for a given quota (i.e. switch to the default, hard-coded rate)\n# curl -XDELETE http://localhost:8139/quotas/tremolo\n")),(0,r.yg)("p",null,"Example kibana view demonstrating the change in number of tremolo logs, after setting the quota dynamically from the above api:"),(0,r.yg)("blockquote",null,(0,r.yg)("p",{parentName:"blockquote"},(0,r.yg)("img",{alt:"Kibana View for Quota Service Demo",src:o(94916).A,width:"1920",height:"604"}))),(0,r.yg)("p",null,(0,r.yg)("strong",{parentName:"p"},"Debug request")),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-sh"},'$ curl -XPOST localhost:8139/echo -d\'{"snot": "badger"}\'\n\n{"body":"{\\"snot\\": \\"badger\\"}","meta":{"method":"POST","headers":{"content-length":["18"],"content-type":["application/x-www-form-urlencoded"],"user-agent":["curl/7.65.3"],"accept":["*/*"],"host":["localhost:8139"]},"url":{"scheme":"http","host":"localhost","port":8139,"path":"/echo"}}}\n')))}g.isMDXComponent=!0},94916:(e,t,o)=>{o.d(t,{A:()=>a});const a=o.p+"assets/images/tremor_quota_service_demo-e2a62ed11ce449919dbd20396b045610.png"}}]);