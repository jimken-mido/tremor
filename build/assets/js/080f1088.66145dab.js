"use strict";(self.webpackChunktremor_website=self.webpackChunktremor_website||[]).push([[6366],{48786:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>a,contentTitle:()=>i,default:()=>d,frontMatter:()=>o,metadata:()=>p,toc:()=>l});var r=t(58168),s=(t(96540),t(15680));t(40281);const o={},i="HTTP -> Websocket Bridge",p={unversionedId:"recipes/bridges_lt_http_ws/index",id:"version-0.11/recipes/bridges_lt_http_ws/index",title:"HTTP -> Websocket Bridge",description:"All the application code here is available from the docs git repository.",source:"@site/versioned_docs/version-0.11/recipes/34_bridges_lt_http_ws/index.md",sourceDirName:"recipes/34_bridges_lt_http_ws",slug:"/recipes/bridges_lt_http_ws/",permalink:"/docs/0.11/recipes/bridges_lt_http_ws/",draft:!1,editUrl:"https://github.com/tremor-rs/tremor-www/tree/main/versioned_docs/version-0.11/recipes/34_bridges_lt_http_ws/index.md",tags:[],version:"0.11",frontMatter:{},sidebar:"version-0.11/tutorialSidebar",previous:{title:"Websocket Proxy",permalink:"/docs/0.11/recipes/proxies_lt_ws/"},next:{title:"Reverse proxy with Load Balancing",permalink:"/docs/0.11/recipes/reverse_proxy_load_balancing/"}},a={},l=[{value:"Setup",id:"setup",level:2},{value:"Sources and sinks",id:"sources-and-sinks",level:3},{value:"Request flow",id:"request-flow",level:3},{value:"Processing logic",id:"processing-logic",level:3},{value:"Testing",id:"testing",level:2}],c={toc:l},g="wrapper";function d(e){let{components:n,...t}=e;return(0,s.yg)(g,(0,r.A)({},c,t,{components:n,mdxType:"MDXLayout"}),(0,s.yg)("h1",{id:"http---websocket-bridge"},"HTTP -> Websocket Bridge"),(0,s.yg)("admonition",{type:"note"},(0,s.yg)("p",{parentName:"admonition"},"All the application code here is available from the docs ",(0,s.yg)("a",{parentName:"p",href:"https://github.com/tremor-rs/tremor-www/tree/main/versioned_docs/version-0.11/recipes/34_bridges_lt_http_ws/index.md"},"git repository"),".")),(0,s.yg)("p",null,"Example HTTP -> Websocket bridge application built on top of Tremor and meant to be a demonstration of ",(0,s.yg)("a",{parentName:"p",href:"/docs/0.11/operations/linked-transports"},"linked transports"),"."),(0,s.yg)("h2",{id:"setup"},"Setup"),(0,s.yg)("admonition",{type:"tip"},(0,s.yg)("p",{parentName:"admonition"},"All the code here is available in the ",(0,s.yg)("a",{parentName:"p",href:"https://github.com/tremor-rs/tremor-www/tree/main/docs/recipes/34_bridges_lt_http_ws"},"git repository")," as well.")),(0,s.yg)("h3",{id:"sources-and-sinks"},"Sources and sinks"),(0,s.yg)("p",null,"We configure a rest onramp listening on port 9139, that is meant to be a bridge for our ",(0,s.yg)("a",{parentName:"p",href:"/docs/0.11/recipes/servers_lt_ws/"},"example websocket server")," (configured as en endpoint in the websocket offramp here)."),(0,s.yg)("pre",null,(0,s.yg)("code",{parentName:"pre",className:"language-yaml"},'onramp:\n  - id: http\n    type: rest\n    linked: true\n    codec: string\n    config:\n      host: 0.0.0.0\n      port: 9139\n\nofframp:\n  - id: ws\n    type: ws\n    linked: true\n    codec: string\n    postprocessors:\n      - lines\n    config:\n      url: "ws://tremor-server:8139"\n')),(0,s.yg)("h3",{id:"request-flow"},"Request flow"),(0,s.yg)("p",null,"Incoming HTTP requests from clients are forwarded to the ",(0,s.yg)("inlineCode",{parentName:"p"},"request_processing")," pipeline, from where it goes to the websocket server. The resulting websocket message reply is then sent back as HTTP response to the client which initiated the request (after some needed processing from the ",(0,s.yg)("inlineCode",{parentName:"p"},"response_processing")," pipeline)."),(0,s.yg)("pre",null,(0,s.yg)("code",{parentName:"pre",className:"language-yaml"},'binding:\n  - id: main\n    links:\n      # send incoming requests for processing\n      "/onramp/http/{instance}/out":\n        ["/pipeline/request_processing/{instance}/in"]\n\n      # process incoming requests and relay it to ws offramp\n      "/pipeline/request_processing/{instance}/out":\n        ["/offramp/ws/{instance}/in"]\n\n      # send the response from ws offramp to the passthrough pipeline\n      # this works well as long as the passthrough pipeline is not used\n      # by anything else (which is the case for this example)\n      "/offramp/ws/{instance}/out":\n        ["/pipeline/response_processing/{instance}/in"]\n\n      # send the ws repsonse back as a response to incoming\n      "/pipeline/response_processing/{instance}/out":\n        ["/onramp/http/{instance}/in"]\n')),(0,s.yg)("h3",{id:"processing-logic"},"Processing logic"),(0,s.yg)("p",null,"Implementation for the ",(0,s.yg)("inlineCode",{parentName:"p"},"request_processing")," pipeline:"),(0,s.yg)("pre",null,(0,s.yg)("code",{parentName:"pre",className:"language-trickle"},'define script process\nscript\n  match $request.url.path of\n    # only pass requests to /bridge\n    case "/bridge" =>\n      null\n    default =>\n      # can send this to a different port than the default err port too\n      emit {\n        "error": "Unsupported url path: {$request.url.path}",\n        "event": event\n      } => "err"\n  end;\n  event;\nend;\n\ncreate script process;\n\n# main request processing\nselect event from in into process;\nselect event from process into out;\n\n# tremor runtime errors from the processing script\nselect event from process/err into err;\n')),(0,s.yg)("p",null,"Implementation for the ",(0,s.yg)("inlineCode",{parentName:"p"},"response_processing")," pipeline:"),(0,s.yg)("pre",null,(0,s.yg)("code",{parentName:"pre",className:"language-trickle"},'define script process\nscript\n  # defaults for the server response\n  let $response = {\n    "status": 200,\n    "headers": {\n      "x-powered-by": "Tremor",\n    }\n  };\n  event;\nend;\n\ncreate script process;\n\n# main request processing\nselect event from in into process;\nselect event from process into out;\n\n# tremor runtime errors from the processing script\nselect event from process/err into err;\n')),(0,s.yg)("h2",{id:"testing"},"Testing"),(0,s.yg)("p",null,"Assuming you have all the code from the ",(0,s.yg)("a",{parentName:"p",href:"https://github.com/tremor-rs/tremor-www/tree/main/docs/recipes/34_bridges_lt_http_ws"},"git repository"),", run the following to start our application (along with the ",(0,s.yg)("a",{parentName:"p",href:"/docs/0.11/recipes/servers_lt_ws/"},"tremor websocket server example")," that our application is bridging to):"),(0,s.yg)("pre",null,(0,s.yg)("code",{parentName:"pre",className:"language-sh"},"docker compose up\n")),(0,s.yg)("p",null,"Now let's try to test the echo capabilities of the websocket server example, via the HTTP bridge:"),(0,s.yg)("pre",null,(0,s.yg)("code",{parentName:"pre",className:"language-sh"},'# via the HTTP bridge\n$ curl -i http://localhost:9139/bridge -d "hello"\nHTTP/1.1 200 OK\ncontent-length: 5\ndate: Thu, 15 Oct 2020 05:24:23 GMT\ncontent-type: text/plain\nx-powered-by: Tremor\n\nhello\n\n\n# the websocket server\n$ echo "hello" | websocat -n1 ws://localhost:8139\nhello\n')),(0,s.yg)("p",null,"Our snot-handling works as well:"),(0,s.yg)("pre",null,(0,s.yg)("code",{parentName:"pre",className:"language-sh"},'$ curl -i http://localhost:9139/bridge -d "snot"\nbadger\n')),(0,s.yg)("p",null,"Only the ",(0,s.yg)("inlineCode",{parentName:"p"},"/bridge")," path (as setup from the pipeline) works for the bridging:"),(0,s.yg)("pre",null,(0,s.yg)("code",{parentName:"pre",className:"language-sh"},'$ curl http://localhost:9139/some_path -d "snot"\n{"error":"Oh no, we ran into something unexpected :(\\n Unsupported url path: /some_path","event":"snot"}\n')),(0,s.yg)("p",null,"And if there's an internal tremor error while processing both the incoming HTTP request and the websocket reply to it (eg: codec or pre/post-processor failure), or if the websocket server is down, an error will be bubbled up to the client. Example:"),(0,s.yg)("pre",null,(0,s.yg)("code",{parentName:"pre",className:"language-sh"},'# stop the websocket server\n$ docker stop 34_bridges_lt_http_ws_tremor-server_1\n\n# websocket server connection now gets closed from the bridge\n$ curl -i http://localhost:9139/bridge -d "hello"\nHTTP/1.1 500 Internal Server Error\ncontent-length: 198\ndate: Fri, 16 Oct 2020 04:12:11 GMT\ncontent-type: application/json\n\n{"error":"Oh no, we ran into something unexpected :(\\n Error receiving reply from server ws://localhost:8139: WebSocket protocol error: Connection reset without closing handshake","event_id":"1:0:3"}\n\nInternally the websocket offramp is trying to re-establish the connection continuously.\n\nRestarting the docker websocket server will heal the offramp:\n\n```sh\n# restart the websocket server\n$ docker start 34_bridges_lt_http_ws_tremor-server_1\n\n$ curl http://localhost:9139/bridge -d "hello"\nhello\n')))}d.isMDXComponent=!0}}]);