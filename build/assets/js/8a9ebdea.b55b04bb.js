"use strict";(self.webpackChunktremor_website=self.webpackChunktremor_website||[]).push([[2412],{99888:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>i,default:()=>d,frontMatter:()=>o,metadata:()=>a,toc:()=>c});var r=n(58168),s=(n(96540),n(15680));n(40281);const o={},i="Websocket Server",a={unversionedId:"recipes/servers_lt_ws/index",id:"version-0.11/recipes/servers_lt_ws/index",title:"Websocket Server",description:"All the application code here is available from the docs git repository.",source:"@site/versioned_docs/version-0.11/recipes/31_servers_lt_ws/index.md",sourceDirName:"recipes/31_servers_lt_ws",slug:"/recipes/servers_lt_ws/",permalink:"/docs/0.11/recipes/servers_lt_ws/",draft:!1,editUrl:"https://github.com/tremor-rs/tremor-www/tree/main/versioned_docs/version-0.11/recipes/31_servers_lt_ws/index.md",tags:[],version:"0.11",frontMatter:{},sidebar:"version-0.11/tutorialSidebar",previous:{title:"HTTP Server",permalink:"/docs/0.11/recipes/servers_lt_http/"},next:{title:"HTTP Proxy",permalink:"/docs/0.11/recipes/proxies_lt_http/"}},l={},c=[{value:"Setup",id:"setup",level:2},{value:"Sources",id:"sources",level:3},{value:"Message flow",id:"message-flow",level:3},{value:"Processing logic",id:"processing-logic",level:3},{value:"Testing",id:"testing",level:2}],p={toc:c},g="wrapper";function d(e){let{components:t,...o}=e;return(0,s.yg)(g,(0,r.A)({},p,o,{components:t,mdxType:"MDXLayout"}),(0,s.yg)("h1",{id:"websocket-server"},"Websocket Server"),(0,s.yg)("admonition",{type:"note"},(0,s.yg)("p",{parentName:"admonition"},"All the application code here is available from the docs ",(0,s.yg)("a",{parentName:"p",href:"https://github.com/tremor-rs/tremor-www/tree/main/versioned_docs/version-0.11/recipes/31_servers_lt_ws/index.md"},"git repository"),".")),(0,s.yg)("p",null,"Example Websocket server application built on top of Tremor and meant to be a demonstration of ",(0,s.yg)("a",{parentName:"p",href:"/docs/0.11/operations/linked-transports"},"linked transports"),"."),(0,s.yg)("h2",{id:"setup"},"Setup"),(0,s.yg)("admonition",{type:"tip"},(0,s.yg)("p",{parentName:"admonition"},"All the code here is available in the ",(0,s.yg)("a",{parentName:"p",href:"https://github.com/tremor-rs/tremor-www/tree/main/docs/recipes/31_servers_lt_ws"},"git repository")," as well.")),(0,s.yg)("h3",{id:"sources"},"Sources"),(0,s.yg)("p",null,"We configure a websocket onramp listening on port 8139:"),(0,s.yg)("pre",null,(0,s.yg)("code",{parentName:"pre",className:"language-yaml"},"  - id: ws\n    type: ws\n    linked: true\n    codec: string\n    preprocessors:\n      - lines\n    config:\n      host: 0.0.0.0\n      port: 8139\n")),(0,s.yg)("h3",{id:"message-flow"},"Message flow"),(0,s.yg)("p",null,"Incoming websocket messages from a client's websocket connection are sent to the pipeline ",(0,s.yg)("inlineCode",{parentName:"p"},"echo")," and the output of it is sent back again from the same connection."),(0,s.yg)("pre",null,(0,s.yg)("code",{parentName:"pre",className:"language-yaml"},'binding:\n  - id: main\n    links:\n      "/onramp/ws/{instance}/out": ["/pipeline/echo/{instance}/in"]\n      "/pipeline/echo/{instance}/out": ["/onramp/ws/{instance}/in"]\n')),(0,s.yg)("h3",{id:"processing-logic"},"Processing logic"),(0,s.yg)("p",null,"Implementation for the ",(0,s.yg)("inlineCode",{parentName:"p"},"echo")," pipeline (techincally, echo with one twist):"),(0,s.yg)("pre",null,(0,s.yg)("code",{parentName:"pre",className:"language-trickle"},'define script process\nscript\n  match event of\n    # snot is a badger\n    case "snot" => "badger"\n    default => event\n  end\nend;\n\ncreate script process;\n\n# main request processing\nselect event from in into process;\nselect event from process into out;\n\n# tremor runtime errors from the processing script\nselect event from process/err into err;\n')),(0,s.yg)("h2",{id:"testing"},"Testing"),(0,s.yg)("p",null,"Assuming you have all the code from the ",(0,s.yg)("a",{parentName:"p",href:"https://github.com/tremor-rs/tremor-www/tree/main/docs/recipes/31_servers_lt_ws"},"git repository"),", run the following to start our application:"),(0,s.yg)("pre",null,(0,s.yg)("code",{parentName:"pre",className:"language-sh"},"docker-compose up\n")),(0,s.yg)("p",null,"Test the websocket server with a tool like ",(0,s.yg)("a",{parentName:"p",href:"https://github.com/vi/websocat"},"websocat"),"."),(0,s.yg)("admonition",{type:"note"},(0,s.yg)("p",{parentName:"admonition"},"Can be installed via ",(0,s.yg)("inlineCode",{parentName:"p"},"cargo install websocat")," for the lazy/impatient amongst us")),(0,s.yg)("pre",null,(0,s.yg)("code",{parentName:"pre",className:"language-sh"},"# anything you type and enter, will be echoed back\n# except snot which begets badger\n$ websocat ws://localhost:8139\nhello\nhello\nworld\nworld\nsnot\nbadger\ngoodbye\ngoodbye\n")),(0,s.yg)("p",null,"If there's internal tremor error while processing the incoming message (eg: codec or preprocessor failure), the error should be bubbled up to the client. To test this out, change the codec in the ",(0,s.yg)("a",{target:"_blank",href:n(33300).A},"onramp configuration")," to be ",(0,s.yg)("inlineCode",{parentName:"p"},"json")," from ",(0,s.yg)("inlineCode",{parentName:"p"},"string")," and send an malformed json input:"),(0,s.yg)("pre",null,(0,s.yg)("code",{parentName:"pre",className:"language-sh"},'# after changing the onramp codec to json\n$ echo "{" | websocat -n1 ws://localhost:8139\n{"error":"SIMD JSON error: Syntax at character 0 (\'{\')","event_id":0,"source_id":"tremor://localhost/onramp/ws/01/in"}\n')))}d.isMDXComponent=!0},33300:(e,t,n)=>{n.d(t,{A:()=>r});const r=n.p+"assets/files/config-4db9f5245d0be4f851a179cd9ef2c0d7.yaml"}}]);