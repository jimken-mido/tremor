"use strict";(self.webpackChunktremor_website=self.webpackChunktremor_website||[]).push([[3334],{70810:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>i,default:()=>m,frontMatter:()=>r,metadata:()=>a,toc:()=>p});var o=t(58168),s=(t(96540),t(15680));t(40281);const r={},i="Websocket Proxy",a={unversionedId:"recipes/proxies_lt_ws/index",id:"version-0.11/recipes/proxies_lt_ws/index",title:"Websocket Proxy",description:"All the application code here is available from the docs git repository.",source:"@site/versioned_docs/version-0.11/recipes/33_proxies_lt_ws/index.md",sourceDirName:"recipes/33_proxies_lt_ws",slug:"/recipes/proxies_lt_ws/",permalink:"/docs/0.11/recipes/proxies_lt_ws/",draft:!1,editUrl:"https://github.com/tremor-rs/tremor-www/tree/main/versioned_docs/version-0.11/recipes/33_proxies_lt_ws/index.md",tags:[],version:"0.11",frontMatter:{},sidebar:"version-0.11/tutorialSidebar",previous:{title:"HTTP Proxy",permalink:"/docs/0.11/recipes/proxies_lt_http/"},next:{title:"HTTP -> Websocket Bridge",permalink:"/docs/0.11/recipes/bridges_lt_http_ws/"}},l={},p=[{value:"Setup",id:"setup",level:2},{value:"Sources and sinks",id:"sources-and-sinks",level:3},{value:"Message flow",id:"message-flow",level:3},{value:"Processing logic",id:"processing-logic",level:3},{value:"Testing",id:"testing",level:2}],c={toc:p},g="wrapper";function m(e){let{components:n,...t}=e;return(0,s.yg)(g,(0,o.A)({},c,t,{components:n,mdxType:"MDXLayout"}),(0,s.yg)("h1",{id:"websocket-proxy"},"Websocket Proxy"),(0,s.yg)("admonition",{type:"note"},(0,s.yg)("p",{parentName:"admonition"},"All the application code here is available from the docs ",(0,s.yg)("a",{parentName:"p",href:"https://github.com/tremor-rs/tremor-www/tree/main/versioned_docs/version-0.11/recipes/33_proxies_lt_ws/index.md"},"git repository"),".")),(0,s.yg)("p",null,"Example Websocket proxy application built on top of Tremor and meant to be a demonstration of ",(0,s.yg)("a",{parentName:"p",href:"/docs/0.11/operations/linked-transports"},"linked transports"),"."),(0,s.yg)("h2",{id:"setup"},"Setup"),(0,s.yg)("admonition",{type:"tip"},(0,s.yg)("p",{parentName:"admonition"},"All the code here is available in the ",(0,s.yg)("a",{parentName:"p",href:"https://github.com/tremor-rs/tremor-www/tree/main/docs/recipes/33_proxies_lt_ws"},"git repository")," as well.")),(0,s.yg)("h3",{id:"sources-and-sinks"},"Sources and sinks"),(0,s.yg)("p",null,"We configure a websocket onramp listening on port 9139, that is meant to be a proxy for our ",(0,s.yg)("a",{parentName:"p",href:"/docs/0.11/recipes/servers_lt_ws/"},"example websocket server")," (configured as en endpoint in the websocket offramp here)."),(0,s.yg)("pre",null,(0,s.yg)("code",{parentName:"pre",className:"language-yaml"},'onramp:\n  - id: ws\n    type: ws\n    linked: true\n    codec: string\n    preprocessors:\n      - lines\n    config:\n      host: 0.0.0.0\n      port: 9139\n\nofframp:\n  - id: upstream\n    type: ws\n    linked: true\n    codec: string\n    postprocessors:\n      - lines\n    config:\n      url: "ws://tremor-server:8139"\n')),(0,s.yg)("h3",{id:"message-flow"},"Message flow"),(0,s.yg)("p",null,"Incoming websocket messages from a client's websocket connection are forwarded to the upstream websocket server (via the ",(0,s.yg)("inlineCode",{parentName:"p"},"pass_incoming")," pipeline which lives up to its name). The resulting upstream reply is then returned back to the client reusing its connection (after a quick pass through the ",(0,s.yg)("inlineCode",{parentName:"p"},"pass_outgoing")," pipeline)."),(0,s.yg)("pre",null,(0,s.yg)("code",{parentName:"pre",className:"language-yaml"},'binding:\n  - id: main\n    links:\n      "/onramp/ws/{instance}/out":\n        ["/pipeline/pass_incoming/{instance}/in"]\n\n      "/pipeline/pass_incoming/{instance}/out":\n        ["/offramp/upstream/{instance}/in"]\n\n      "/offramp/upstream/{instance}/out":\n        ["/pipeline/pass_outgoing/{instance}/in"]\n\n      "/pipeline/pass_outgoing/{instance}/out":\n        ["/onramp/ws/{instance}/in"]\n')),(0,s.yg)("h3",{id:"processing-logic"},"Processing logic"),(0,s.yg)("p",null,"Implementation for the ",(0,s.yg)("inlineCode",{parentName:"p"},"pass_incoming")," (as well as ",(0,s.yg)("inlineCode",{parentName:"p"},"pass_outgoing"),") pipeline:"),(0,s.yg)("pre",null,(0,s.yg)("code",{parentName:"pre",className:"language-trickle"},"select event from in into out;\n")),(0,s.yg)("p",null,"This example is intentionally light on the processing but you can imagine doing arbitrary processing based on the event data here (as well as dynamically changing the confiuration for the ",(0,s.yg)("a",{parentName:"p",href:"/docs/0.11/artefacts/offramps#ws"},"websocket offramp")," via its metadata variables --  eg: things like the server url)."),(0,s.yg)("h2",{id:"testing"},"Testing"),(0,s.yg)("p",null,"Assuming you have all the code from the ",(0,s.yg)("a",{parentName:"p",href:"https://github.com/tremor-rs/tremor-www/tree/main/docs/recipes/33_proxies_lt_ws"},"git repository"),", run the following to start our application (along with the ",(0,s.yg)("a",{parentName:"p",href:"/docs/0.11/recipes/servers_lt_ws/"},"tremor websocket server example")," that is the upstream for our proxy):"),(0,s.yg)("pre",null,(0,s.yg)("code",{parentName:"pre",className:"language-sh"},"docker-compose up\n")),(0,s.yg)("p",null,"Now let's try to test the echo capabilities of our upstream server, via a tool like ",(0,s.yg)("a",{parentName:"p",href:"https://github.com/vi/websocat"},"websocat"),"."),(0,s.yg)("admonition",{type:"note"},(0,s.yg)("p",{parentName:"admonition"},"Can be installed via ",(0,s.yg)("inlineCode",{parentName:"p"},"cargo install websocat")," for the lazy/impatient amongst us")),(0,s.yg)("pre",null,(0,s.yg)("code",{parentName:"pre",className:"language-sh"},'# via proxy\n$ echo "hello" | websocat -n1 ws://localhost:9139\nhello\n\n# the upstream\n$ echo "hello" | websocat -n1 ws://localhost:8139\nhello\n')),(0,s.yg)("p",null,"Our snot-handling works as well:"),(0,s.yg)("pre",null,(0,s.yg)("code",{parentName:"pre",className:"language-sh"},'$ echo "snot" | websocat -n1 ws://localhost:9139\nbadger\n')),(0,s.yg)("p",null,"And if there's an internal tremor error while processing both the incoming message and the upstream reply to it (eg: codec or pre/post-processor failure), or if the upstream server is down, an error will be bubbled up to the client. Example:"),(0,s.yg)("pre",null,(0,s.yg)("code",{parentName:"pre",className:"language-sh"},'# stop the upstream server\n$ docker stop 33_proxies_lt_ws_tremor-server_1\n\n# upstream connection now gets closed from the proxy\n$ echo "hello" | websocat -n1 ws://localhost:9139\n{"error":"Error receiving reply from server ws://localhost:8139: WebSocket protocol error: Connection reset without closing handshake","event_id":"\n1:0:9"}\n\n# sending further messages results in errors\n$ echo "hello" | websocat -n1 ws://localhost:9139\n$ echo "hello" | websocat -n1 ws://localhost:9139\n{"error":"Error sending event to server ws://localhost:8139: Trying to work with closed connection","event_id":"1:0:10"}\n')))}m.isMDXComponent=!0}}]);