<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">Case Study - Multi-Participant Transaction Orchestration | Tremor</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://www.tremor.rs/blog/2021/11/07/search"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Case Study - Multi-Participant Transaction Orchestration | Tremor"><meta data-rh="true" name="description" content="The support for multi-participant transaction orchestration in tremor"><meta data-rh="true" property="og:description" content="The support for multi-participant transaction orchestration in tremor"><meta data-rh="true" property="og:image" content="https://www.tremor.rs/assets/images/wayfair-b0bafac5cf230fcd5e29c8cb4560c334.png"><meta data-rh="true" name="twitter:image" content="https://www.tremor.rs/assets/images/wayfair-b0bafac5cf230fcd5e29c8cb4560c334.png"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2021-11-07T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://github.com/tremor-rs"><meta data-rh="true" property="article:tag" content="case-study,wayfair"><link data-rh="true" rel="icon" href="/static/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://www.tremor.rs/blog/2021/11/07/search"><link data-rh="true" rel="alternate" href="https://www.tremor.rs/blog/2021/11/07/search" hreflang="en"><link data-rh="true" rel="alternate" href="https://www.tremor.rs/blog/2021/11/07/search" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Tremor RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Tremor Atom Feed"><link rel="stylesheet" href="/assets/css/styles.8fde9d3c.css">
<link rel="preload" href="/assets/js/runtime~main.0a24082e.js" as="script">
<link rel="preload" href="/assets/js/main.fe542851.js" as="script">
</head>
<body class="navigation-with-keyboard" data-theme="light">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a href="https://www.tremor.rs/" target="_self" rel="noopener noreferrer" class="navbar__brand"><div class="navbar__logo"><img src="/img/tremor-logo.svg" alt="Tremor Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/tremor-logo.svg" alt="Tremor Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div></a><a class="navbar__item navbar__link" href="/docs/0.12/getting-started/">Getting Started</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a><div class="navbar__item dropdown dropdown--hoverable"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" positition="left" href="/docs/0.12">Docs</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/0.12/guides/">Guides</a></li><li><a class="dropdown__link" href="/docs/0.12/reference/">Reference Documentation</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/docs/0.12/">0.12</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/edge/">edge</a></li><li><a class="dropdown__link" href="/docs/0.12/">0.12</a></li><li><a class="dropdown__link" href="/docs/0.11/">0.11</a></li></ul></div></div><div class="navbar__items navbar__items--right"><a href="https://github.com/tremor-rs" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="searchBox_ZlJk"><div class="dsla-search-wrapper"><div class="dsla-search-field" data-tags="default,docs-default-0.12,docs-rfc-current"></div></div></div><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2022/09/24/LFX-Blog-Carol">Hygienic error handling and validation for pipelines</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2022/07/07/LFX-Blog-Sasha">Support for the ClickHouse database in Tremor</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2022/06/15/tdengine-colaboration">TDengine colaboration</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2022/06/03/LFX-Blog-Prashant">Automating the tremor release process</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2022/06/02/tremor-tremors">Tremors - May &#x27;22</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="image" content="https://www.tremor.rs/assets/images/wayfair-b0bafac5cf230fcd5e29c8cb4560c334.png"><header><h1 class="title_f1Hy" itemprop="headline">Case Study - Multi-Participant Transaction Orchestration</h1><div class="container_mt6G margin-vert--md"><time datetime="2021-11-07T00:00:00.000Z" itemprop="datePublished">November 7, 2021</time> · <!-- -->9 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/tremor-rs" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/60009416?s=200&amp;v=4" alt="The Tremor Team"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/tremor-rs" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">The Tremor Team</span></a></div></div></div></div></div></header><div id="__blog-post-container" class="markdown" itemprop="articleBody"><p>The support for multi-participant transaction orchestration in tremor
originates with this use case from Wayfair&#x27;s Search platform services
team.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="identified-need">Identified Need<a href="#identified-need" class="hash-link" aria-label="Direct link to Identified Need" title="Direct link to Identified Need">​</a></h2><p>One of the frequent requests made of the tremor team by peers in the
Infrastructure organization at Wayfair has come from the search domain.
Search is a critical service at Wayfair and it is the powerplant behind
many other services - ranging from recommendation engines through to
auditing of data streams that are continually being ingested and indexed
into multiple searchable databases.</p><p>At a very high level - streams of documents need to be elementized and
broken down into one or many indexable items of interest - these items
then need to be indexed ( successfully ) into one or many search
engines.</p><p>Many of the use cases that are battle tested with tremor are relevant in
this domain:</p><ul><li>Cleansing, normalization and enrichment of documents and indexable
elementization and tracking documents and elementized items</li><li>Rate limiting, capacity-based load-shedding, with domain classification
similar to the traffic shaping use cases where tremor started</li><li>Sourcing, transformation and distribution of documents and the
synthetic events in real-time at low or very low latencies</li></ul><p>But, for the use case at hand, there are additional needs:</p><ul><li>All documents must be processed transactionally, without loss and
with proper reporting of processing outcome to upstream services and
the documents must be processed in arrival order. The guaranteed
delivery and circuit-breaker mechanisms in tremor now need to be
multi-pipeline.</li><li>All indexable elements of all documents must be indexed in multiple
downstream engines successfully ( or operator errors produced for
exceptions ) while all possible error cases need to be caught and
reported upstream in order to issue retries or let operators
intervene. This is a reasonably orchestration mapping processed elements and tracing
back to the documents the elements were produced from before publication
down stream.</li><li>There is significant variability, variant on a case by case basis, to the exact semantics
required for different document types to be processed to a varying number of downstream
indexing systems and technologies. The solution needs to be modular</li></ul><p>Gathering and aggregating multiple parallel processing outcomes and
subsuming them under a common transaction is outside of the baseline
scope of message-based and message-like systems as they typically only
support point-to-point transactions. Correlation across multiple event
streams usually needs to be solved on the application level. Where
systems support orchestrated transactions - these are typically
constrained by transport/protocol or other factors beyond the
application authors control, and therefore inflexible under variant (
and often fast-changing ) production needs.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="required-outcome">Required Outcome<a href="#required-outcome" class="hash-link" aria-label="Direct link to Required Outcome" title="Direct link to Required Outcome">​</a></h2><p>Expand on tremor’s QoS facilities so that multi-participant transaction
orchestration is possible, easily composable and user programmable.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="characteristics">Characteristics<a href="#characteristics" class="hash-link" aria-label="Direct link to Characteristics" title="Direct link to Characteristics">​</a></h3><p>The original use cases for tremor were relatively straightforward and
data distribution applications with a requirement for traffic shaping
and rate limiting for data streams when downstream systems were prone to
being overwhelmed at peak traffic conditions.</p><p>These occurrences were rare - but their impact was high when they
happened. And in an infrastructure with higher high peaks year on year
this is an ever-present hazard of doing business.</p><p>More recently, delivery guarantees are expanding as new domains adopt
tremor in production. In these domains data loss, even user defined and
strictly capacity managed traffic shaping, is not tolerable.  </p><p>Like with many real-time systems - the percentage of the overall
in-flight volumetric that requires transactional delivery is typically a
small subset of the overall firehose. Take financial trading systems for
example - orders and trades are transactional and they need to be
processed, each and every one, correctly - as there are fiscal and
regulatory conditions that need to be strictly met.  </p><p>But pricing - the ability to buy or sell and equity, or the current
currency rate is often naturally continuously changing due to supply and
demand, and naturally redundant - as you can buy or sell the same stock
on many different venues.</p><p>The search case stretches the QoS mechanisms in tremor and the internal
mechanisms used to track events as they are processed from a single set
of flows and a small set of participants - to larger and more complex
user defined flows that orchestrate transactions of arbitrary
complexity.  </p><p>This is compounded by tremor-based applications today being large,
increasingly sophisticated and modular. So the QoS mechanisms that were
originally constrained to the boundary of a single pipeline - now need
to be preserved and propagated across an entire deployment.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="solution">Solution<a href="#solution" class="hash-link" aria-label="Direct link to Solution" title="Direct link to Solution">​</a></h2><p>Tremor’s core processing element - pipelines - are executable
directed-acyclic graphs.</p><p>A tremor user designs a workflow or pipeline using the tremor query
language.</p><p>Tremor converts this to a directed graph and makes sure that it is
acyclic.</p><p>Tremor transforms and optimizes the user defined graph to an executable
form that is well-structured for easily supporting easy to understand
and easy to define qualities of service.</p><p>If we imagine the pipeline graph as a single larger directed-acyclic
graph we have what tremor actually uses for event distribution
internally. Tremor can distribute and process user defined events -
these are business or data events that originate from connectors or user
defined logic.  </p><p>Tremor can inject control events - these are runtime events that tremor
uses for quality of service and they are not ordinarily user visible.
Tremor can also inject events originating at outputs ( or that propagate
from downstream systems ) backwards to inputs ( or for propagation to
upstream systems ). But, we can do so without introducing cycles.</p><p>The user-defined graph is acyclic. But the tremor runtime has, in
effect, the ability to coordinate acknowledgements for user-defined
events and an ability to signal upstream breaks in connectivity to
downstream systems, or downstream breaks to upstream systems. These
runtime control events - we call them signal-flow and contra-flow - are
transparent to users.  </p><p>Our <code>wal</code> ( write-ahead-log ) operator produces and consumes
signal-flow and contra-flow events.  </p><p>So, given a simple tremor application that has no defined QoS ( it does
not use guaranteed delivery )  </p><div class="language-trickle codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockTitle_Ktv7">/etc/tremor/config/lossy.trickle</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-trickle codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">select patch event of</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  insert hostname = system::hostname()</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">end</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">from in into out;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="we-can-configure-the-wal-operator">We can configure the <code>wal</code> operator<a href="#we-can-configure-the-wal-operator" class="hash-link" aria-label="Direct link to we-can-configure-the-wal-operator" title="Direct link to we-can-configure-the-wal-operator">​</a></h3><div class="language-trickle codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockTitle_Ktv7">/etc/tremor/config/mostly_guaranteed.trickle</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-trickle codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">use tremor::system;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">define qos::wal operator in_memory_wal</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">with  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> read_count = 20,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  max_elements = 1000, # Capacity limit of 1000 stored events</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  max_bytes = 10485760 # Capacity limit of 1MB of events</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">end;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">create operator in_memory_wal;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">select patch event of</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  insert hostname = system::hostname()</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">end</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">from in into in_memory_wal;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">select event from in_memory_wal into out;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This is a logically equivalent application - but we can tolerate a lag
of up to 1000 events or 1 megabyte of data before losing data. Under the
hood of course - events are now tracked and traced. If connectors are
QoS aware then we now have a more robust application.</p><p>So if we are consuming from a kafka cluster upstream and distributing to
another kafka cluster downstream ( such as in another data center ) -
those systems can go offline briefly or be disconnected. The connectors
themselves handle lossless delivery ( that’s handled by kafka in both
cases in this example ). Connectors with less strong guarantees can
still be ( mostly ) lossless - so if our downstream system is HTTP-based
( like elasticsearch ) - we can tolerate transient service loss and
fully recover.  </p><p>What if tremor or the host it is deployed on is rebooted?</p><div class="language-trickle codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockTitle_Ktv7">/etc/tremor/config/mostly_guaranteed.trickle</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-trickle codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">use tremor::system;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">define qos::wal operator in_memory_wal</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">with  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  dir = ”./recovery”, # Persistent file-based recovery file</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  read_count = 20,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  max_elements = 1000, # Capacity limit of 1000 stored events</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  max_bytes = 10485760 # Capacity limit of 1MB of events</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">end;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">create operator in_memory_wal;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">select patch event of</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  insert hostname = system::hostname()</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">end</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">from in into in_memory_wal;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">select event from in_memory_wal into out;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The tremor developer doesn’t need to be too concerned with the internal
mechanisms, or their implementation. And for simple applications with a
single primary data flow, its as easy as the examples above to
selectively introduce grades of guaranteed delivery with a spectrum of
robustness that derives from choice of connectivity ( kafka vs http ) or
how the <a href="https://www.tremor.rs/docs/tremor-query/operators/" target="_blank" rel="noopener noreferrer">qos</a>
operators are chosen, placed in a flow, and configured.</p><p>Orchestration however, is different. In an orchestrated transaction the
user defined logic provided by the tremor developer also needs to do
some tracking. This is achieved through using tremor’s state mechanism
alongside the <code>qos</code> capabilities and operators that tremor provides to
compose a solution.  </p><p>So, in our search case - let us say we have two downstream search
engines - and both need to index a different set of items of interest
elementized from a single document - we use the state mechanism to track
progress of the items for each participant - and when all participants
have indexes up to date - we issue a synthetic event ( that can be
recorded in a wal ) that publishes the document processing status
downstream.</p><p><img loading="lazy" alt="search logic" src="/assets/images/image1-cb4dd9235b1af1100251fcd71cac1652.png" width="960" height="720" class="img_ev3q"></p><p>So our document source is kafka, our indexing engines for elementized
items and our destination for successfully elementized documents ( which
may now be enriched with elementization metadata and index metadata )
can now be published ( let’s assume kafka again for simplicity ) to an
audited topic.  </p><p>The state mechanism in tremor is a readable/writable value - so
persistent and recoverable state is a relatively simple composition:  </p><div class="language-trickle codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-trickle codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">define script remember</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">script</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  let state = event;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  event</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">end;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">define qos::wal operator forget_me_not</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">with</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  dir = &quot;./brain&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  read_count = 1,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  max_elements = 1000, # Capacity limit of 1000 stored events</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  max_bytes = 10485760 # Capacity limit of 1MB of events</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">end;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">create script remember;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">create operator forget_me_not;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">select event from in into remember;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">select event from remember into forget_me_not;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">select event from forget_me_not into out;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Please don’t run out of disk space!</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">​</a></h2><p>Most of the changes required to evolve tremor form supporting great qos
for simple single pipeline applications to complex multi-pipeline and
multi-participant stateful orchestrations did not expose new features to
the tremor developer or user.  </p><p>It has been a significant change to tremor internals, however and the
work reaches a stable point with our <code>0.12</code> release - the ability to
<code>pause</code> and <code>resume</code> connectors, and the ability for the tremor
runtime itself to detect and act on <code>quiescence</code> will mean that tremor
is flexible enough for the demands and use cases that originated in the
search domain.</p></div><footer class="row docusaurus-mt-lg blogPostFooterDetailsFull_mRVl"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/case-study">case-study</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/wayfair">wayfair</a></li></ul></div><div class="col margin-top--sm"><a href="https://github.com/tremor-rs/tremor-www/tree/main/blog/2021-11-07-search.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/blog/2021/11/08/uop"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Case Study - Unified Observability Platform</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/blog/2021/11/06/modularity"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Case Study - Modularity, Oh My</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#identified-need" class="table-of-contents__link toc-highlight">Identified Need</a></li><li><a href="#required-outcome" class="table-of-contents__link toc-highlight">Required Outcome</a><ul><li><a href="#characteristics" class="table-of-contents__link toc-highlight">Characteristics</a></li></ul></li><li><a href="#solution" class="table-of-contents__link toc-highlight">Solution</a><ul><li><a href="#we-can-configure-the-wal-operator" class="table-of-contents__link toc-highlight">We can configure the <code>wal</code> operator</a></li></ul></li><li><a href="#conclusion" class="table-of-contents__link toc-highlight">Conclusion</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Social</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://chat.tremor.rs/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/TremorDEBS" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Media</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.youtube.com/channel/UCg1hxwEjh9szpYg8SxL0U7Q" target="_blank" rel="noopener noreferrer" class="footer__link-item">YouTube<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">
          Copyright © 2025, Tremor Authors | Documentation Distributed under CC-BY-4.0.<br><br>
              <p style="font-size: smaller;">Hosted by: <a href="https://www.netlify.com/" rel="noreferrer noopener" aria-label="Netlify"><img src="/img/netlify-full-logo.svg" alt="CNCF" style="width: 3%;"></a>
              &nbsp;&nbsp;&nbsp;&nbsp;
              Project of: <a href="https://www.cncf.io/" rel="noreferrer noopener" aria-label="CNCF"><img src="/img/cncf-color.svg" alt="CNCF" style="width: 5%;"></a></p>
        <small>© 2025 The Linux Foundation. All rights reserved. The Linux Foundation has registered trademarks and uses trademarks. For a list of trademarks of The Linux Foundation, please see our <a href="https://www.linuxfoundation.org/trademark-usage/">Trademark Usage</a> page.</small>
        </div></div></div></footer></div>
<script src="/assets/js/runtime~main.0a24082e.js"></script>
<script src="/assets/js/main.fe542851.js"></script>
</body>
</html>