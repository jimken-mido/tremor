<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">To async or Not to async | Tremor</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://www.tremor.rs/blog/2020/08/06/to-async-or-not-to-async"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="To async or Not to async | Tremor"><meta data-rh="true" name="description" content="Moving from threads to async tasks."><meta data-rh="true" property="og:description" content="Moving from threads to async tasks."><meta data-rh="true" property="og:image" content="https://www.tremor.rs/img/async.png"><meta data-rh="true" name="twitter:image" content="https://www.tremor.rs/img/async.png"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2020-08-06T00:00:00.000Z"><meta data-rh="true" property="article:tag" content="dev,rust"><link data-rh="true" rel="icon" href="/static/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://www.tremor.rs/blog/2020/08/06/to-async-or-not-to-async"><link data-rh="true" rel="alternate" href="https://www.tremor.rs/blog/2020/08/06/to-async-or-not-to-async" hreflang="en"><link data-rh="true" rel="alternate" href="https://www.tremor.rs/blog/2020/08/06/to-async-or-not-to-async" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Tremor RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Tremor Atom Feed"><link rel="stylesheet" href="/assets/css/styles.8fde9d3c.css">
<link rel="preload" href="/assets/js/runtime~main.0a24082e.js" as="script">
<link rel="preload" href="/assets/js/main.fe542851.js" as="script">
</head>
<body class="navigation-with-keyboard" data-theme="light">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a href="https://www.tremor.rs/" target="_self" rel="noopener noreferrer" class="navbar__brand"><div class="navbar__logo"><img src="/img/tremor-logo.svg" alt="Tremor Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/tremor-logo.svg" alt="Tremor Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div></a><a class="navbar__item navbar__link" href="/docs/0.12/getting-started/">Getting Started</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a><div class="navbar__item dropdown dropdown--hoverable"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" positition="left" href="/docs/0.12">Docs</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/0.12/guides/">Guides</a></li><li><a class="dropdown__link" href="/docs/0.12/reference/">Reference Documentation</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/docs/0.12/">0.12</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/edge/">edge</a></li><li><a class="dropdown__link" href="/docs/0.12/">0.12</a></li><li><a class="dropdown__link" href="/docs/0.11/">0.11</a></li></ul></div></div><div class="navbar__items navbar__items--right"><a href="https://github.com/tremor-rs" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="searchBox_ZlJk"><div class="dsla-search-wrapper"><div class="dsla-search-field" data-tags="default,docs-default-0.12,docs-rfc-current"></div></div></div><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2022/09/24/LFX-Blog-Carol">Hygienic error handling and validation for pipelines</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2022/07/07/LFX-Blog-Sasha">Support for the ClickHouse database in Tremor</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2022/06/15/tdengine-colaboration">TDengine colaboration</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2022/06/03/LFX-Blog-Prashant">Automating the tremor release process</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2022/06/02/tremor-tremors">Tremors - May &#x27;22</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="image" content="https://www.tremor.rs/img/async.png"><header><h1 class="title_f1Hy" itemprop="headline">To async or Not to async</h1><div class="container_mt6G margin-vert--md"><time datetime="2020-08-06T00:00:00.000Z" itemprop="datePublished">August 6, 2020</time> · <!-- -->6 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/60009416?s=200&amp;v=4" alt="The Tremor Team"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">The Tremor Team</span></div></div></div></div></div></header><div id="__blog-post-container" class="markdown" itemprop="articleBody"><p>With the upcoming Tremor release, 0.9.0, we&#x27;re moving from threads as a basis for ramps and pipelines to async tasks.</p><p>Let&#x27;s talk about why this is significant, what is changing, and how the architecture is changing.</p><p>Note that this is not a comprehensive treatise on threads or async tasks.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-tremor-that-was-threads">The Tremor That Was (threads)<a href="#the-tremor-that-was-threads" class="hash-link" aria-label="Direct link to The Tremor That Was (threads)" title="Direct link to The Tremor That Was (threads)">​</a></h2><p>Threads are a basic building block of programs that run multiple pieces of code concurrently.
The operating system is responsible for coordinating across competing resource demands.</p><p>The OS can preempt, pause, and resume threads. We can leverage infinite or tight loops without the risk of completely blocking the system. These guarantees make concurrent code more accessible, with tools like<code>crossbeam-channels</code> to build upon.</p><p>Threads work especially well in use cases where the system and logical concurrency models are well aligned; or, we can map application threads to logical cores on the system being used. Each thread can happily work away on its part of the logic and pass the result on to the next. The one thread per core model is what tremor 0.8 and earlier used. We had a thread for the onramp, a thread for the pipeline, and a thread for the offramp. As the computational cost of decoding, processing, and encoding was often in the same ballpark, this worked exceptionally well. We managed to push up to 400MB/s of JSON through the system this way (including parsing, tremor-script logic, and serialization).</p><p>This design can degenerate badly if there are more ramps and pipelines than cores on the system in use. Throughput degrades rapidly (as in up to 2 orders of magnitude worse at 30:1 ratio). At the time of writing this, the deployment model was one pipeline/ramp group on a four-core system, so it worked well in practice.</p><p>However, this places a burden on operators having to think about concurrency and parallelism to tune tremor for optimal performance and capacity.</p><p>In SMP systems, we observe other undesireable effects: The moment two communicating threads don&#x27;t share the same underlying cache, performance plummets. This scenario exists when threads reside on two different CPUs or CCXs (<a href="https://blog.licenser.net/2020/01/multithreaded-rust-on-threadripper/" target="_blank" rel="noopener noreferrer">thank you AMD for making me learn so much about CPU caches</a>). As long as two communicating threads share the same cache, data shared between them can avoid trips to main memory and cache coherency protocol overheads. When two threads communicate across different caches, reads/writes may catastrophically collide and introduce overheads that drastically reduce overall performance.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="asyncfutures">Async/Futures<a href="#asyncfutures" class="hash-link" aria-label="Direct link to Async/Futures" title="Direct link to Async/Futures">​</a></h2><p>Futures, and in rust <code>async/await</code> (short async from here on), work differently than threads. With threads, the operating system has ultimate control over which thread is scheduled to work when. With async we can more flexibly manage scheduling in application code. This has many advantages in systems software.</p><p>Instead of the operating system preempting a thread, tasks require coordination within the application. The advantage is that since we can control where we take a pause, we can provide soft guarantees that the thread of control yields to the task schedulers in a way that better fits the application. A good example is async-io, where we allow another task to work whenever we have to wait for some IO.</p><p>In Tremor, we use channels extensively to coordinate event flows. They connect sources, sinks, and pipelines. Every time a channel is empty or full, we have to wait for a event that fills or drains a now blocked channel: This is a good juncture to let other tasks get ahead with their work. In tremor, these opportunities are fairly common.</p><p>The cooperative model is not without issues: If we select the wrong time to let other tasks work, we can hurt performance or even break the system. Giving up control in the right moment is especially tricky since it is sometimes happening implicitly. A task that loops without yielding forever is an extreme example. In OS managed threads, the OS can preempt a thread of control, so this is a non-issue. In user-managed tasks, however, this is an issue that needs to be protected against.</p><p>In rust, calling <code>.await</code> is effectively, not a guarantee. We cannot know if an async function ever yields. We can ensure that we yield control via yield_now. However, this comes at a cost: namely, that we might yield in situations where it is not strictly necessary.</p><p>With regards to performance, tasks are typically cheaper from a context switching perspective, and we have finer grained control. On the other hand, we lose control over where a task runs, while we can pin threads to cores to schedule affinity on SMP systems, tasks may migrate across cores or runners move freely.</p><p>In Tremor, we have adopted the <code>smol</code> small and fast async runtime. When two tasks can run consecutively on the same executor, <code>smol</code> will schedule them in different executors. A significant improvement over the thread-based tremor runtime is that <code>smol</code> does not aggressively steal work from other schedulers if they are not overloaded. This avoids the runtime trashing CPU caches based on <a href="https://github.com/async-rs/async-std/issues/848" target="_blank" rel="noopener noreferrer">micro-benchmarking results</a>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="behavioural-improvements">Behavioural Improvements<a href="#behavioural-improvements" class="hash-link" aria-label="Direct link to Behavioural Improvements" title="Direct link to Behavioural Improvements">​</a></h2><p>In previous releases of Tremor, the runtime focused on situations where applications had a limited and bounded number of stable long-lived concurrent pipelines in each instance. While multiple running artefacts were supported, in practice, tremor was deployed on systems with up to 4 logical cores.</p><p>This works exceptionally well with plain old threads. Starting with v0.9, Tremor is expanding to support an arbitrary number of running artefacts in a typical running instance, with a different logical core topology than production deployments to date.</p><p>Deploying a higher number of pipelines per instance changes our needs of the underlying concurrency mechanisms considerably. The plain old threads design will no longer scale to meet these changing requirements and the move to task-based scheduling with executors favours emerging workloads whilst incurring a negligible overhead to classic tremor workloads.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="initial-results">Initial Results<a href="#initial-results" class="hash-link" aria-label="Direct link to Initial Results" title="Direct link to Initial Results">​</a></h2><p>Ab initio, the switch has some practical implications, mainly an improvement in performance.</p><p>In Tremor v0.8.0, colocating pipelines required careful capacity planning and tuning by experienced operators. In tremor v0.9.0, this constraint has been lifted and the capacity planning burden drastically simplified. Improvements in <code>smol</code> itself over the last few versions means that we have broken the 500MB/s throughput barrier for the first time with the new task-based runtime, which is quite a nice bonus.</p><p>Let&#x27;s end with some pretty graphs. After all, a picture says more than a thousand words.</p><p>As a short explanation, this uses the json-throughput benchmark we have developed for Tremor running with deployments of one onramp, one pipeline, and one offramp to 64 onramps, 64 pipelines, and one offramp.</p><p><img loading="lazy" alt="3 core performance" src="/assets/images/async-3-cores-afcbd1a0052cfec4bd1e0810535a910c.png" width="568" height="342" class="img_ev3q"></p><p><img loading="lazy" alt="48 core performance" src="/assets/images/async-48-cores-cb4557c688e68d35251683aba21454f8.png" width="572" height="339" class="img_ev3q"></p></div><footer class="row docusaurus-mt-lg blogPostFooterDetailsFull_mRVl"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/dev">dev</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/rust">rust</a></li></ul></div><div class="col margin-top--sm"><a href="https://github.com/tremor-rs/tremor-www/tree/main/blog/2020-08-06-to-async-or-not-to-async.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/blog/2020/10/16/v09-release"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Releasing Tremor v0.9!</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/blog/2020/03/31/rust-and-tell"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Rust &amp; Tell Berlin- March 2020</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#the-tremor-that-was-threads" class="table-of-contents__link toc-highlight">The Tremor That Was (threads)</a></li><li><a href="#asyncfutures" class="table-of-contents__link toc-highlight">Async/Futures</a></li><li><a href="#behavioural-improvements" class="table-of-contents__link toc-highlight">Behavioural Improvements</a></li><li><a href="#initial-results" class="table-of-contents__link toc-highlight">Initial Results</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Social</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://chat.tremor.rs/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/TremorDEBS" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Media</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.youtube.com/channel/UCg1hxwEjh9szpYg8SxL0U7Q" target="_blank" rel="noopener noreferrer" class="footer__link-item">YouTube<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">
          Copyright © 2025, Tremor Authors | Documentation Distributed under CC-BY-4.0.<br><br>
              <p style="font-size: smaller;">Hosted by: <a href="https://www.netlify.com/" rel="noreferrer noopener" aria-label="Netlify"><img src="/img/netlify-full-logo.svg" alt="CNCF" style="width: 3%;"></a>
              &nbsp;&nbsp;&nbsp;&nbsp;
              Project of: <a href="https://www.cncf.io/" rel="noreferrer noopener" aria-label="CNCF"><img src="/img/cncf-color.svg" alt="CNCF" style="width: 5%;"></a></p>
        <small>© 2025 The Linux Foundation. All rights reserved. The Linux Foundation has registered trademarks and uses trademarks. For a list of trademarks of The Linux Foundation, please see our <a href="https://www.linuxfoundation.org/trademark-usage/">Trademark Usage</a> page.</small>
        </div></div></div></footer></div>
<script src="/assets/js/runtime~main.0a24082e.js"></script>
<script src="/assets/js/main.fe542851.js"></script>
</body>
</html>