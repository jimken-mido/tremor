<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">Improving our Influx Parser- A Story in Four Acts | Tremor</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://www.tremor.rs/blog/2020/03/06/influx-perf"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Improving our Influx Parser- A Story in Four Acts | Tremor"><meta data-rh="true" name="description" content="The process of improving the performance of our influx line protocol parser."><meta data-rh="true" property="og:description" content="The process of improving the performance of our influx line protocol parser."><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2020-03-06T00:00:00.000Z"><meta data-rh="true" property="article:tag" content="perf"><link data-rh="true" rel="icon" href="/static/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://www.tremor.rs/blog/2020/03/06/influx-perf"><link data-rh="true" rel="alternate" href="https://www.tremor.rs/blog/2020/03/06/influx-perf" hreflang="en"><link data-rh="true" rel="alternate" href="https://www.tremor.rs/blog/2020/03/06/influx-perf" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Tremor RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Tremor Atom Feed"><link rel="stylesheet" href="/assets/css/styles.8fde9d3c.css">
<link rel="preload" href="/assets/js/runtime~main.0a24082e.js" as="script">
<link rel="preload" href="/assets/js/main.fe542851.js" as="script">
</head>
<body class="navigation-with-keyboard" data-theme="light">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a href="https://www.tremor.rs/" target="_self" rel="noopener noreferrer" class="navbar__brand"><div class="navbar__logo"><img src="/img/tremor-logo.svg" alt="Tremor Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/tremor-logo.svg" alt="Tremor Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div></a><a class="navbar__item navbar__link" href="/docs/0.12/getting-started/">Getting Started</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a><div class="navbar__item dropdown dropdown--hoverable"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" positition="left" href="/docs/0.12">Docs</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/0.12/guides/">Guides</a></li><li><a class="dropdown__link" href="/docs/0.12/reference/">Reference Documentation</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/docs/0.12/">0.12</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/edge/">edge</a></li><li><a class="dropdown__link" href="/docs/0.12/">0.12</a></li><li><a class="dropdown__link" href="/docs/0.11/">0.11</a></li></ul></div></div><div class="navbar__items navbar__items--right"><a href="https://github.com/tremor-rs" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="searchBox_ZlJk"><div class="dsla-search-wrapper"><div class="dsla-search-field" data-tags="default,docs-default-0.12,docs-rfc-current"></div></div></div><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2022/09/24/LFX-Blog-Carol">Hygienic error handling and validation for pipelines</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2022/07/07/LFX-Blog-Sasha">Support for the ClickHouse database in Tremor</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2022/06/15/tdengine-colaboration">TDengine colaboration</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2022/06/03/LFX-Blog-Prashant">Automating the tremor release process</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2022/06/02/tremor-tremors">Tremors - May &#x27;22</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="title_f1Hy" itemprop="headline">Improving our Influx Parser- A Story in Four Acts</h1><div class="container_mt6G margin-vert--md"><time datetime="2020-03-06T00:00:00.000Z" itemprop="datePublished">March 6, 2020</time> · <!-- -->9 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/60009416?s=200&amp;v=4" alt="The Tremor Team"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">The Tremor Team</span></div></div></div></div></div></header><div id="__blog-post-container" class="markdown" itemprop="articleBody"><p>Yesterday, we spent the day on a report <a href="https://github.com/tremor-rs/tremor-runtime/issues/82" target="_blank" rel="noopener noreferrer">that our influx parser was slow</a>, and it turns out it was indeed.</p><p>This is an exciting topic as a few days ago, we <a href="https://bobkonf.de/2020/ennis-gies.html" target="_blank" rel="noopener noreferrer">gave a talk at BoBKonf 2020</a> on this topic, so this is a great opportunity to show some of the topics and our process in action.</p><p>All the topics in this blog are links; the main one above this text is to the pull request, the titles of each section link to the commit that implements the topic discussed. Go ahead, click on some, and take a look!</p><p>There are two tools worth introducing here that we used during this performance session.</p><p>One is <a href="http://brendangregg.com/perf.html" target="_blank" rel="noopener noreferrer">perf</a>, which we used with a minimal setup of <code>perf record</code> and <code>perf report</code>. We use this to get a glance at where code is spending time. This is not perfect, but it is quick for decent results.</p><p>The other one is <a href="https://docs.rs/criterion/0.3.1/criterion/" target="_blank" rel="noopener noreferrer">criterion</a>, an excellent Rust framework for microbenchmarks based on the <a href="https://hackage.haskell.org/package/criterion" target="_blank" rel="noopener noreferrer">haskell framework</a> with the same name. It is so helpful since it allows us to show changes in performance between changes. That makes it perfect for the kind of incremental improvements our process favors.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="act-1---allocation"><a href="https://github.com/tremor-rs/tremor-runtime/pull/87/commits/42ee11637bc5cd3a215cce1cb841afe791b944b4" target="_blank" rel="noopener noreferrer">Act 1 - Allocation</a><a href="#act-1---allocation" class="hash-link" aria-label="Direct link to act-1---allocation" title="Direct link to act-1---allocation">​</a></h2><p>We talked a bit about allocations and how they can slow down programs in our talk. We tackled two main areas there, and both of them applied to this benchmark.</p><p>First, we switched our allocator to ensure we use the same allocator in both our builds, and the benchmark can make a significant difference!</p><p>Second, we found a few places where we used <code>String::new()</code> and then push to this String - this is one of the patterns we mentioned in our talk, and as you can see in this PR, something we still do wrong at times.</p><p>From prior experience, we know that tag names, values, and field names rarely, if ever, are larger than <code>256</code> characters, so we preallocate with this to eliminate almost all string relocations during parsing.</p><p>As you can see, this change already had a decent impact on performance.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">base-value            time:   [540.03 ns 540.27 ns 540.53 ns]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                       change: [-14.017% -13.948% -13.884%] (p = 0.00 &lt; 0.05)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                       Performance has improved.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">int-value               time:   [314.67 ns 314.90 ns 315.14 ns]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                       change: [-8.9227% -8.8709% -8.8179%] (p = 0.00 &lt; 0.05)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                       Performance has improved.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Found 13 outliers among 100 measurements (13.00%)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> 1 (1.00%) low mild</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> 12 (12.00%) high mild</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">str-value               time:   [460.68 ns 460.92 ns 461.16 ns]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                       change: [-11.668% -11.617% -11.564%] (p = 0.00 &lt; 0.05)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                       Performance has improved.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Found 4 outliers among 100 measurements (4.00%)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> 1 (1.00%) low mild</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> 2 (2.00%) high mild</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> 1 (1.00%) high severe</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">escaped-value           time:   [477.57 ns 478.02 ns 478.51 ns]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                       change: [-13.262% -12.894% -12.594%] (p = 0.00 &lt; 0.05)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                       Performance has improved.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Found 1 outliers among 100 measurements (1.00%)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> 1 (1.00%) high mild</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="act-2---degeneralisation"><a href="https://github.com/tremor-rs/tremor-runtime/pull/87/commits/d1490fb940ad99ca3570e4af8c5f5407c4d054e6" target="_blank" rel="noopener noreferrer">Act 2 - Degeneralisation</a><a href="#act-2---degeneralisation" class="hash-link" aria-label="Direct link to act-2---degeneralisation" title="Direct link to act-2---degeneralisation">​</a></h2><p>When we originally wrote the code, what we did is generalize the &quot;find a character&quot; logic between the cases where we were looking for one, two, or three distinct characters to terminate a token.</p><p>That made sense from the perspective of not duplicating code, however looking at the output of perf, it showed that we&#x27;re spending an awful lot of time in this one particular function.</p><p>So we split this function into its three cases and implemented each on its own, allowing simplified code for one and two termination characters. This simplifies the logic and, in result, improves performance for those cases.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">base-value            time:   [533.13 ns 534.49 ns 536.02 ns]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                       change: [-1.5482% -1.3801% -1.1996%] (p = 0.00 &lt; 0.05)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                       Performance has improved.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Found 3 outliers among 100 measurements (3.00%)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> 2 (2.00%) high mild</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> 1 (1.00%) high severe</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">int-value               time:   [287.45 ns 287.61 ns 287.78 ns]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                       change: [-8.5277% -8.4504% -8.3783%] (p = 0.00 &lt; 0.05)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                       Performance has improved.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">str-value               time:   [428.11 ns 428.38 ns 428.68 ns]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                       change: [-7.2129% -7.1458% -7.0775%] (p = 0.00 &lt; 0.05)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                       Performance has improved.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Found 2 outliers among 100 measurements (2.00%)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> 1 (1.00%) low mild</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> 1 (1.00%) high mild</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">escaped-value           time:   [446.53 ns 447.30 ns 448.53 ns]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                       change: [-6.6970% -6.5679% -6.4161%] (p = 0.00 &lt; 0.05)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                       Performance has improved.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Found 7 outliers among 100 measurements (7.00%)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> 6 (6.00%) high mild</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> 1 (1.00%) high severe</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="act-3---outside-help"><a href="https://github.com/tremor-rs/tremor-runtime/pull/87/commits/6c9ee7ce64d1474bbd609f7ad99e4303b0ee98df" target="_blank" rel="noopener noreferrer">Act 3 - Outside help</a><a href="#act-3---outside-help" class="hash-link" aria-label="Direct link to act-3---outside-help" title="Direct link to act-3---outside-help">​</a></h2><p>Not all performance improvements have to be written in code, sometimes asking the right question and looking for the right thing can do the trick.</p><p><a href="https://docs.rs/lexical/" target="_blank" rel="noopener noreferrer">lexical</a> is a rust library that implements a faster version of number parsing, which is a significant part of what influx line protocol is.</p><p>The changes are minimal, and as you can see, the impact isn&#x27;t that huge, but every percentage point counts.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">base-value            time:   [522.24 ns 522.45 ns 522.69 ns]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                       change: [-0.3955% -0.2589% -0.1477%] (p = 0.00 &lt; 0.05)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                       Change within noise threshold.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Found 13 outliers among 100 measurements (13.00%)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> 2 (2.00%) low mild</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> 4 (4.00%) high mild</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> 7 (7.00%) high severe</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">int-value               time:   [295.19 ns 295.38 ns 295.56 ns]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                       change: [-1.9771% -1.6929% -1.5006%] (p = 0.00 &lt; 0.05)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                       Performance has improved.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Found 5 outliers among 100 measurements (5.00%)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> 3 (3.00%) low mild</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> 1 (1.00%) high mild</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> 1 (1.00%) high severe</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">str-value               time:   [421.03 ns 421.25 ns 421.46 ns]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                       change: [-3.0571% -2.9466% -2.8421%] (p = 0.00 &lt; 0.05)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                       Performance has improved.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Found 8 outliers among 100 measurements (8.00%)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> 3 (3.00%) low severe</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> 1 (1.00%) low mild</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> 3 (3.00%) high mild</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> 1 (1.00%) high severe</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">escaped-value           time:   [433.66 ns 434.61 ns 435.77 ns]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                       change: [-2.9065% -2.7290% -2.5090%] (p = 0.00 &lt; 0.05)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                       Performance has improved.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Found 4 outliers among 100 measurements (4.00%)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> 1 (1.00%) high mild</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> 3 (3.00%) high severe</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="act-4---borrow-vs-owned"><a href="https://github.com/tremor-rs/tremor-runtime/pull/87/commits/eb24fd9c3f5982a2dae743abd41a75a4253eec07" target="_blank" rel="noopener noreferrer">Act 4 - Borrow vs. Owned</a><a href="#act-4---borrow-vs-owned" class="hash-link" aria-label="Direct link to act-4---borrow-vs-owned" title="Direct link to act-4---borrow-vs-owned">​</a></h2><p>The last act is a bit more exciting, so we&#x27;ll spend extra time on it (both here and when implementing it).</p><p>This touches on something we didn&#x27;t discuss in detail during our talk for the sake of time. It is that owned values instead of borrowed values are
significantly more expensive.</p><p>While &#x27;owned&#x27; and &#x27;borrowed&#x27; are very Rust-specific terms, you can think about it this way:</p><p>An owned value is a value that has its own memory, on creation, it allocates that memory copies the data in, and when it gets freed, the memory too gets freed.</p><p>A borrowed value doesn&#x27;t own the memory it refers to. Instead, it borrows the memory from another value, and now those two are tied to each other. Rust uses lifetimes to represent this- this is a vast topic of its own, so we&#x27;ll not go into details here, but think about it that a borrowed value in some way is a pointer to someone else&#x27;s memory.</p><p>For influx data, a lot of the strings can are perfectly fine represented inside the initial memory; they don&#x27;t need modification or change to be then used in the final data representation.</p><p>The first implementation ignored this fact and always created a newly owned data structure - this is expensive (as you will see below). However, it&#x27;s not only that. Not all strings can be passed, pointing to the original memory. Influx uses some escaping in its line protocol that makes this impossible.</p><p>Fortunately, Rust has a data structure that allows representing the situation where we often return borrowed data but sometimes need to own it- it&#x27;s named a <code>Cow</code>. No, not that cow, it doesn&#x27;t eat grass, it is a Copy On Write structure that we can use to cover the &quot;we sometimes need to own the data&quot; situation.</p><p>In short, a <code>Cow&lt; &#x27;_, str&gt;</code> allows returning either a borrowed <code>&amp;str</code> or an owned String - perfect for our use case!</p><p>Since most of the time we can return the <code>&amp;str</code> we use a trick I picked up from the <a href="https://github.com/maciejhirsz/json-rust/blob/master/src/codegen.rs#L67-L99" target="_blank" rel="noopener noreferrer">json crate</a> that is to split out the logic in a base and a complex case where the base case can perform the common operation quickly and only if it is required we switch to the complex and more costly implementation.</p><p>In our case, this means we assume that all strings can be returned as borrowed, and only if we find an escape sequence, we switch to a more complex implementation. While this has some extra cost on the rare case, it makes the typical case rather cheap.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">base-value            time:   [385.62 ns 385.85 ns 386.06 ns]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                       change: [-25.171% -25.122% -25.073%] (p = 0.00 &lt; 0.05)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                       Performance has improved.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Found 5 outliers among 100 measurements (5.00%)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> 1 (1.00%) low severe</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> 3 (3.00%) low mild</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> 1 (1.00%) high mild</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">int-value               time:   [240.91 ns 241.37 ns 241.97 ns]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                       change: [-18.169% -18.051% -17.905%] (p = 0.00 &lt; 0.05)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                       Performance has improved.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Found 1 outliers among 100 measurements (1.00%)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> 1 (1.00%) high severe</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">str-value               time:   [308.08 ns 308.17 ns 308.27 ns]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                       change: [-26.978% -26.901% -26.833%] (p = 0.00 &lt; 0.05)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                       Performance has improved.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Found 8 outliers among 100 measurements (8.00%)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> 1 (1.00%) low severe</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> 4 (4.00%) low mild</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> 3 (3.00%) high mild</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">escaped-value           time:   [368.73 ns 369.05 ns 369.38 ns]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                       change: [-15.303% -15.233% -15.160%] (p = 0.00 &lt; 0.05)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                       Performance has improved.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Found 3 outliers among 100 measurements (3.00%)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> 1 (1.00%) low mild</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion"><a href="https://github.com/tremor-rs/tremor-runtime/pull/87" target="_blank" rel="noopener noreferrer">Conclusion</a><a href="#conclusion" class="hash-link" aria-label="Direct link to conclusion" title="Direct link to conclusion">​</a></h2><p>So we performed 3 rudimentary and one more complex tweaks, and this doubled the performance of our influx parsing. As you can see, a few tweaks, when added together, can have some massive impact.</p><p>The most important take away here, however, is the process and that it is iterative.</p><p>We begin each round by looking at measurements, in this case, perf data. Then collect baseline data, in this case, with criterion. From there, we form a theory what could improve the results, implement a solution based on this theory, and finally validate the results with another run of criterion to see the relative diference.</p><p>And here the final results of all changes combined:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">Gnuplot not found, using plotters backend</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">base-value            time:   [376.98 ns 377.26 ns 377.52 ns]                         </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                        change: [-55.627% -55.569% -55.518%] (p = 0.00 &lt; 0.05)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                        Performance has improved.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Found 3 outliers among 100 measurements (3.00%)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  2 (2.00%) low mild</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  1 (1.00%) high mild</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">int-value               time:   [233.04 ns 233.19 ns 233.34 ns]                      </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                        change: [-47.584% -47.507% -47.435%] (p = 0.00 &lt; 0.05)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                        Performance has improved.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">str-value               time:   [302.36 ns 302.43 ns 302.50 ns]                      </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                        change: [-58.246% -58.202% -58.159%] (p = 0.00 &lt; 0.05)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                        Performance has improved.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Found 6 outliers among 100 measurements (6.00%)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  2 (2.00%) low mild</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  4 (4.00%) high mild</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">escaped-value           time:   [364.08 ns 364.35 ns 364.67 ns]                          </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                        change: [-52.159% -52.084% -52.004%] (p = 0.00 &lt; 0.05)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                        Performance has improved.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Found 8 outliers among 100 measurements (8.00%)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  8 (8.00%) high severe</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><footer class="row docusaurus-mt-lg blogPostFooterDetailsFull_mRVl"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/perf">perf</a></li></ul></div><div class="col margin-top--sm"><a href="https://github.com/tremor-rs/tremor-www/tree/main/blog/2020-03-06-influx-perf.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/blog/2020/03/31/rust-and-tell"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Rust &amp; Tell Berlin- March 2020</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/blog/2020/02/22/welcome"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Tremor is now Open Source!</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#act-1---allocation" class="table-of-contents__link toc-highlight">Act 1 - Allocation</a></li><li><a href="#act-2---degeneralisation" class="table-of-contents__link toc-highlight">Act 2 - Degeneralisation</a></li><li><a href="#act-3---outside-help" class="table-of-contents__link toc-highlight">Act 3 - Outside help</a></li><li><a href="#act-4---borrow-vs-owned" class="table-of-contents__link toc-highlight">Act 4 - Borrow vs. Owned</a></li><li><a href="#conclusion" class="table-of-contents__link toc-highlight">Conclusion</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Social</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://chat.tremor.rs/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/TremorDEBS" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Media</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.youtube.com/channel/UCg1hxwEjh9szpYg8SxL0U7Q" target="_blank" rel="noopener noreferrer" class="footer__link-item">YouTube<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">
          Copyright © 2025, Tremor Authors | Documentation Distributed under CC-BY-4.0.<br><br>
              <p style="font-size: smaller;">Hosted by: <a href="https://www.netlify.com/" rel="noreferrer noopener" aria-label="Netlify"><img src="/img/netlify-full-logo.svg" alt="CNCF" style="width: 3%;"></a>
              &nbsp;&nbsp;&nbsp;&nbsp;
              Project of: <a href="https://www.cncf.io/" rel="noreferrer noopener" aria-label="CNCF"><img src="/img/cncf-color.svg" alt="CNCF" style="width: 5%;"></a></p>
        <small>© 2025 The Linux Foundation. All rights reserved. The Linux Foundation has registered trademarks and uses trademarks. For a list of trademarks of The Linux Foundation, please see our <a href="https://www.linuxfoundation.org/trademark-usage/">Trademark Usage</a> page.</small>
        </div></div></div></footer></div>
<script src="/assets/js/runtime~main.0a24082e.js"></script>
<script src="/assets/js/main.fe542851.js"></script>
</body>
</html>