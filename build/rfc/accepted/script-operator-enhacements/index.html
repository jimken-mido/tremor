<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-rfc docs-doc-id-accepted/script-operator-enhacements">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">script-operator-enhacements | Tremor</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://www.tremor.rs/rfc/accepted/script-operator-enhacements"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-rfc-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-rfc-current"><meta data-rh="true" property="og:title" content="script-operator-enhacements | Tremor"><meta data-rh="true" name="description" content="- Feature Name: script operator enhancements"><meta data-rh="true" property="og:description" content="- Feature Name: script operator enhancements"><link data-rh="true" rel="icon" href="/static/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://www.tremor.rs/rfc/accepted/script-operator-enhacements"><link data-rh="true" rel="alternate" href="https://www.tremor.rs/rfc/accepted/script-operator-enhacements" hreflang="en"><link data-rh="true" rel="alternate" href="https://www.tremor.rs/rfc/accepted/script-operator-enhacements" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Tremor RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Tremor Atom Feed"><link rel="stylesheet" href="/assets/css/styles.8fde9d3c.css">
<link rel="preload" href="/assets/js/runtime~main.0a24082e.js" as="script">
<link rel="preload" href="/assets/js/main.fe542851.js" as="script">
</head>
<body class="navigation-with-keyboard" data-theme="light">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a href="https://www.tremor.rs/" target="_self" rel="noopener noreferrer" class="navbar__brand"><div class="navbar__logo"><img src="/img/tremor-logo.svg" alt="Tremor Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/tremor-logo.svg" alt="Tremor Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div></a><a class="navbar__item navbar__link" href="/docs/0.12/getting-started/">Getting Started</a><a class="navbar__item navbar__link" href="/blog">Blog</a><div class="navbar__item dropdown dropdown--hoverable"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" positition="left" href="/docs/0.12">Docs</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/0.12/guides/">Guides</a></li><li><a class="dropdown__link" href="/docs/0.12/reference/">Reference Documentation</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/docs/0.12/">0.12</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/edge/">edge</a></li><li><a class="dropdown__link" href="/docs/0.12/">0.12</a></li><li><a class="dropdown__link" href="/docs/0.11/">0.11</a></li></ul></div></div><div class="navbar__items navbar__items--right"><a href="https://github.com/tremor-rs" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="searchBox_ZlJk"><div class="dsla-search-wrapper"><div class="dsla-search-field" data-tags="default,docs-default-0.12,docs-rfc-current"></div></div></div><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/rfc/">RFCs</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/rfc/accepted/pipeline-state-mechanism">Accepted</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/rfc/accepted/pipeline-state-mechanism">Pipeline State Mechanism</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/rfc/accepted/sliding-window-mechanism">Sliding Window Mechanism</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/rfc/accepted/plugin-development-kit">Plugin development Kit</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/rfc/accepted/ramp-interface">Ramp Interface</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/rfc/accepted/script-operator-enhacements">script-operator-enhacements</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/rfc/accepted/binary-type">binary-type</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/rfc/accepted/troy">troy</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/rfc/implemented/remove-actix-from-tremor-runtime">Implemented</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/rfc/process/template">RFC Process</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Accepted</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">script-operator-enhacements</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>script-operator-enhacements</h1></header><ul><li>Feature Name: <code>script</code> operator enhancements</li><li>Start Date: 2021-04-28</li><li>Tremor Issue: <a href="https://github.com/tremor-rs/tremor-runtime/issues/960" target="_blank" rel="noopener noreferrer">tremor-rs/tremor-runtime#960</a> <a href="https://github.com/tremor-rs/tremor-runtime/issues/933" target="_blank" rel="noopener noreferrer">tremor-rs/tremor-runtime#933</a></li><li>RFC PR: <a href="https://github.com/tremor-rs/tremor-rfcs/pull/0000" target="_blank" rel="noopener noreferrer">tremor-rs/tremor-rfcs#0000</a></li></ul><h1>Summary</h1><p>This RFC aims to add quality of life improvements to the script operator. As it exists today, the operator works well for simple use-cases but-in light of the growing number of complex pipelines and the use of patterns like the configurator pattern it is cumbersome. When first implemented, <code>state</code> didn&#x27;t exist, and ports were not used. Those are the areas of improvement this RFC tackles.</p><p>The improvements focus around handling of state and tackle two common cases:</p><p>1) decupling the control plane logic (setting / modifying state) and the data plane logic (using state to make decisions)
2) seeding the state with a value</p><h1>Motivation</h1><p>To demonstrate we will give a motivating example if the reduction of complexity for a simplified algorithm for distributed loadbalancing:</p><p>The original code has to contend with not knowing what ports data comes in and having to verify the initalization of state on every event.</p><div class="language-trickle codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-trickle codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">define grouper::bucket operator bucketing;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">define script lb</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">with</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  rate = 0,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  peer = {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;host&quot;: &quot;127.0.0.1&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;port&quot;: 4242</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  },</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  self = {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;host&quot;: &quot;127.0.0.1&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;port&quot;: 4243</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">script</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  # If the state isn&#x27;t intialized, do this now</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  match absent state.rate of</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    case true =&gt; let state = {&quot;quota&quot;: args.quota, &quot;rate&quot;: 1.0 }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    default =&gt; null</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  end;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  match event of</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    # we got a delta message in reply that tells us how to adjust our quota</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    case %{ present delta } =&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      let state.quota = state.quota + event.delta</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    # we got a compare message asking us to figure out the adjustment required</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    # apply it, and send it over to the requester</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    case %{ present cmp } =&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      let delta = state.quota * (state.rate - event.rate),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      let state.rate = state.rate - delta,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      let $udp = event.udp,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      emit {&quot;delta&quot;: delta} =&gt; &quot;udp&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    case %{ present rate } =&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      let state.rate = event.rate,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      drop</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    # we are asked to propage our rate</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    case %{ id == &quot;proagate&quot; } =&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      emit { &quot;quota&quot;: state.quota } =&gt; &quot;config&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    # Tick event for periodic checks</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    case %{ id == &quot;tick&quot; } =&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      let $udp = args.peer,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      emit {&quot;cmp&quot;: state.quota, &quot;udp&quot;: args.self } =&gt; &quot;udp&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    case _ =&gt; emit =&gt; &quot;dbg&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  end</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">end;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">define script rate</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">script</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  match event of</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    case %{tags ~= %{node == &quot;bucketing&quot;, port == &quot;out&quot;, action == &quot;pass&quot;} } =&gt; let state.pass = event.fields.count</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    case %{tags ~= %{node == &quot;bucketing&quot;, port == &quot;out&quot;, action == &quot;overflow&quot;} } =&gt; let state.overflow = event.fields.count</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    case _ =&gt; drop</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  end;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  match state of</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    case %{ present pass, present overflow } when state.pass + state.overflow &gt; 0 =&gt; {&quot;rate&quot;: state.pass / (state.pass + state.overflow)}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    case _ =&gt; drop</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  end</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">end;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">define script apply</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">script</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  let rate = match state of</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    case null =&gt; let state = 0</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    case _ =&gt; null</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  end;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  match event of</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    case %{ present quota } =&gt; let state = event.quota, drop</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    case _ =&gt; null</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  end;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  let $class =  &quot;default&quot;;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  let $rate = state</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">end;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">create operator bucketing;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">create script apply;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">create script rate;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">create script lb;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># main data flow</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">select event from in into apply;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">select event from apply into bucketing;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">select event from bucketing into out;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># rate updates from bucketing metrics</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">select event from bucketing/metrics into rate;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">select event from rate into lb/rate;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># rate updates from the load balancing logic</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">select event from lb/config into apply/config;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># udp coms for the load balancer</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">select event from in/udp into lb/udp;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">select event from lb/udp into lb/out;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-trickle codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-trickle codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">define grouper::bucket operator bucketing;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">define script lb</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">with</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  rate = 0,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  peer = {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;host&quot;: &quot;127.0.0.1&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;port&quot;: 4242</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  },</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  self = {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;host&quot;: &quot;127.0.0.1&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;port&quot;: 4243</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">state</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  {&quot;quota&quot;: args.quota, &quot;rate&quot;: 1.0}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">script from &quot;udp&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  match event of</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    case %{ present delta } =&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      let state.quota = state.quota + event.delta,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      drop</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    # we got a compare message asking us to figure out the adjustment required</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    # apply it, and send it over to the requester</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    case %{ present cmp } =&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      let delta = state.quota * (state.rate - event.rate),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      let state.rate = state.rate - delta,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      let $udp = event.udp,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      emit {&quot;delta&quot;: delta} =&gt; &quot;udp&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  end;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># rate update event</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">script from &quot;rate&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  let state.rate = event;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  drop</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># propagation tick to send current quota to new</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">script from &quot;propagate&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  emit { &quot;quota&quot;: state.quota } =&gt; &quot;config&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">script from &quot;tick&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  let $udp = args.peer;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  emit {&quot;cmp&quot;: state.quota, &quot;udp&quot;: args.self } =&gt; &quot;udp&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">script</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  emit =&gt; &quot;dbg&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">end;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">define script rate</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">state</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  {}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">script</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  match event of</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    case %{tags ~= %{node == &quot;bucketing&quot;, port == &quot;out&quot;, action == &quot;pass&quot;} } =&gt; let state.pass = event.fields.count</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    case %{tags ~= %{node == &quot;bucketing&quot;, port == &quot;out&quot;, action == &quot;overflow&quot;} } =&gt; let state.overflow = event.fields.count</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    case _ =&gt; drop</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  end;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  match state of</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    case %{ present pass, present overflow } when state.pass + state.overflow &gt; 0 =&gt; state.pass / (state.pass + state.overflow)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    case _ =&gt; drop</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  end</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">end;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">define script apply</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">state  0</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">script for &quot;config&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  let state = event;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  drop</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">script</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  let $class =  &quot;default&quot;;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  let $rate = state;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  event</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">end;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">create operator bucketing;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">create script apply;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">create script rate;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">create script lb;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># main data flow</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">select event from in into apply;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">select event from apply into bucketing;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">select event from bucketing into out;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># rate updates from bucketing metrics</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">select event from bucketing/metrics into rate;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">select event from rate into lb/rate;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># rate updates from the load balancing logic</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">select event from lb/config into apply/config;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># udp coms for the load balancer</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">select event from in/udp into lb/udp;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">select event from lb/udp into lb/out;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># ticks</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">select event from in/tick into lb/tick;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">select event from in/propagate into lb/propagate;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h1>Guide-level explanation</h1><p>This introduces two new parts to the to the seelct statement.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="state"><code>state</code><a href="#state" class="hash-link" aria-label="Direct link to state" title="Direct link to state">​</a></h2><p>The <code>state</code> section is introduced as an optional section to provide an initial state. One alternative would be calling it <code>init</code> however using that would introduce a new keyword and by that break backwards compatibility and reduce the number of possible idents.</p><p>The content of <code>state</code> would get executed as part of the initialisation and then set once before the script is executes for the first time.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="script-for-port"><code>script for &quot;&lt;port&gt;&quot;</code><a href="#script-for-port" class="hash-link" aria-label="Direct link to script-for-port" title="Direct link to script-for-port">​</a></h2><p>The addition of <code>script for &quot;&lt;port&gt;&quot;</code> allows to define different script path for the different ports connected to the script operator.</p><p>They would share a <code>state</code> but not share local variables or constants. This is an extremely handy pattern in scenarios like the configurator pattern where one set of messages is used to adjust state and the other set of messages being processas as events.</p><p>In other words, it allows seperating control and data plane of a script.</p><h1>Reference-level explanation</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="state-1"><code>state</code><a href="#state-1" class="hash-link" aria-label="Direct link to state-1" title="Direct link to state-1">​</a></h2><p>This will get executed at initiation time to take <code>args</code> into acount. Then never be executed again
in a running pipeline.</p><p>The <code>state</code> section will be optional.</p><p>This means the addition is backwards compatible.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="script-for-port-1"><code>script for &quot;&lt;port&gt;&quot;</code><a href="#script-for-port-1" class="hash-link" aria-label="Direct link to script-for-port-1" title="Direct link to script-for-port-1">​</a></h2><p>This would basically be a loopup table for <code>port</code> -&gt; <code>script</code> with an additional &quot;catch all&quot; <code>script</code>
that gets executed if no port is specified.</p><p>All <code>script for</code> sections will be optional, <code>script</code> itself however madatory.</p><p>This means the addition is backwards compatible.</p><h1>Drawbacks</h1><p>Drawbacks are addition of additional language constructs and introducing the usage of input ports for the first time which might add complexity for users.</p><p>On the other hand as both additions are optional thos complexity is hidden unless explicitly used.</p><h1>Rationale and alternatives</h1><p>One alternative to the <code>state</code> keyword could be replaced by <code>init</code> which might be more intuitive but would add another keyword and break backwards compatibility by that.</p><p>Alternatives for <code>script for</code> would be adding a <code>port</code> keyword to access the port or a <code>system::port()</code> function. The addition of the <code>port</code> keyword would introduce the same backwards compatibility issues as the <code>init</code> keywoard so is likely not a good idea. However adding the <code>system::port()</code> (or a differently named) funciton would be possible in addition without negative impact.</p><h1>Prior art</h1><p><code>init</code> or <code>state</code> pretty much has prior art in most of any language that uses constructors for data.</p><p>Since <code>select from &quot;&lt;port&gt;&quot;</code> is rather specific to the tremor runtime it isn&#x27;t inspired by any prior art.</p><h1>Unresolved questions</h1><p>None at this point.</p><h1>Future possibilities</h1><p>A <code>system::port()</code> (or equivalent) function would be a good addition.</p><p>Another possibility this opens is to allow analyzing different script path and their respective ports. that way we can make a more detailed cycle analysis on a script that has a control plane and a data plane that do not overlap.</p><p>For example:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">define script control_and_data</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">script for &quot;control&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  let state = sevent;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  drop</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">script for event</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  // do something with event</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">end;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">select event from  control_and_data/metrics to control_and_data/control;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">select event from in into out;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Here we could determine that the &quot;control&quot; section never emits data, so no loop is created.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/tremor-rs/tremor-www/tree/main/rfc/accepted/0013-script-operator-enhacements.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/rfc/accepted/ramp-interface"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Ramp Interface</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/rfc/accepted/binary-type"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">binary-type</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#state" class="table-of-contents__link toc-highlight"><code>state</code></a></li><li><a href="#script-for-port" class="table-of-contents__link toc-highlight"><code>script for &quot;&lt;port&gt;&quot;</code></a></li><li><a href="#state-1" class="table-of-contents__link toc-highlight"><code>state</code></a></li><li><a href="#script-for-port-1" class="table-of-contents__link toc-highlight"><code>script for &quot;&lt;port&gt;&quot;</code></a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Social</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://chat.tremor.rs/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/TremorDEBS" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Media</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.youtube.com/channel/UCg1hxwEjh9szpYg8SxL0U7Q" target="_blank" rel="noopener noreferrer" class="footer__link-item">YouTube<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">
          Copyright © 2025, Tremor Authors | Documentation Distributed under CC-BY-4.0.<br><br>
              <p style="font-size: smaller;">Hosted by: <a href="https://www.netlify.com/" rel="noreferrer noopener" aria-label="Netlify"><img src="/img/netlify-full-logo.svg" alt="CNCF" style="width: 3%;"></a>
              &nbsp;&nbsp;&nbsp;&nbsp;
              Project of: <a href="https://www.cncf.io/" rel="noreferrer noopener" aria-label="CNCF"><img src="/img/cncf-color.svg" alt="CNCF" style="width: 5%;"></a></p>
        <small>© 2025 The Linux Foundation. All rights reserved. The Linux Foundation has registered trademarks and uses trademarks. For a list of trademarks of The Linux Foundation, please see our <a href="https://www.linuxfoundation.org/trademark-usage/">Trademark Usage</a> page.</small>
        </div></div></div></footer></div>
<script src="/assets/js/runtime~main.0a24082e.js"></script>
<script src="/assets/js/main.fe542851.js"></script>
</body>
</html>